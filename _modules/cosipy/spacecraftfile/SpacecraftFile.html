

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cosipy.spacecraftfile.SpacecraftFile &mdash; cosipy __version__ = &#34;0.3.4&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=f9fafa83"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            cosipy
              <img src="../../../_static/cosipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/other_examples.html">Other examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/index.html">For developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cosipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cosipy.spacecraftfile.SpacecraftFile</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cosipy.spacecraftfile.SpacecraftFile</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">cartesian_to_spherical</span><span class="p">,</span> <span class="n">Galactic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mhealpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">HealpixMap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span><span class="p">,</span> <span class="n">colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scoords</span><span class="w"> </span><span class="kn">import</span> <span class="n">Attitude</span><span class="p">,</span> <span class="n">SpacecraftFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cosipy.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">FullDetectorResponse</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.scatt_map</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpacecraftAttitudeMap</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="SpacecraftFile">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SpacecraftFile</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">x_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
            <span class="n">z_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">earth_zenith</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">altitude</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
            <span class="n">attitude</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">livetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instrument</span> <span class="o">=</span> <span class="s2">&quot;COSI&quot;</span><span class="p">,</span> \
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the spacecraft orientation. Calculates the dwell time </span>
<span class="sd">        map and point source response over a certain orientation period. </span>
<span class="sd">        Exports the point source response as RMF and ARF files that can be read by XSPEC.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Time : astropy.time.Time</span>
<span class="sd">            The time stamps for each pointings. Note this is NOT the time duration.</span>
<span class="sd">        x_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the x axis of the local </span>
<span class="sd">            coordinate system attached to the spacecraft (the default </span>
<span class="sd">            is `None`, which implies no input for the x pointings).</span>
<span class="sd">        y_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the y axis of the local </span>
<span class="sd">            coordinate system attached to the spacecraft (the default </span>
<span class="sd">            is `None`, which implies no input for the y pointings).</span>
<span class="sd">        z_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the z axis of the local </span>
<span class="sd">            coordinate system attached to the spacecraft (the default </span>
<span class="sd">            is `None`, which implies no input for the z pointings).</span>
<span class="sd">        earth_zenith : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the Earth zenith (the </span>
<span class="sd">            default is `None`, which implies no input for the earth pointings).</span>
<span class="sd">	    altitude : array, optional </span>
<span class="sd">            Altitude of the spacecraft in km.</span>
<span class="sd">        livetime : array, optional </span>
<span class="sd">            Time in seconds the instrument is live for the corresponding </span>
<span class="sd">            energy bin (using left endpoints so that the last entry in </span>
<span class="sd">            the ori file is 0).</span>
<span class="sd">        attitude : numpy.ndarray, optional </span>
<span class="sd">            The attitude of the spacecraft (the default is `None`, </span>
<span class="sd">            which implies no input for the attitude of the spacecraft).</span>
<span class="sd">        instrument : str, optional</span>
<span class="sd">            The instrument name (the default is &quot;COSI&quot;).</span>
<span class="sd">        frame : str, optional</span>
<span class="sd">            The frame on which the analysis will be based (the default is &quot;galactic&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if the inputs are valid</span>
        <span class="c1"># Time</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Time</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The time should be a astropy.time.Time object&quot;</span><span class="p">)</span>

        <span class="c1"># Altitude</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span>

        <span class="c1"># livetime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">livetime</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">livetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">livetime</span><span class="p">)</span>

        <span class="c1"># x pointings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_pointings</span><span class="p">,</span> <span class="p">(</span><span class="n">SkyCoord</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_pointings</span> <span class="o">=</span> <span class="n">x_pointings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The x_pointing should be a NoneType or SkyCoord object!&quot;</span><span class="p">)</span>

        <span class="c1"># y pointings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_pointings</span><span class="p">,</span> <span class="p">(</span><span class="n">SkyCoord</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_pointings</span> <span class="o">=</span> <span class="n">y_pointings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The y_pointing should be a NoneType or SkyCoord object!&quot;</span><span class="p">)</span>

        <span class="c1"># z pointings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z_pointings</span><span class="p">,</span> <span class="p">(</span><span class="n">SkyCoord</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_pointings</span> <span class="o">=</span> <span class="n">z_pointings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The z_pointing should be a NoneType or SkyCoord object!&quot;</span><span class="p">)</span>
	    
	    <span class="c1"># earth pointings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">earth_zenith</span><span class="p">,</span> <span class="p">(</span><span class="n">SkyCoord</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">earth_zenith</span> <span class="o">=</span> <span class="n">earth_zenith</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The earth_zenith should be a NoneType or SkyCoord object!&quot;</span><span class="p">)</span>    

        <span class="c1"># check if the x, y and z pointings are all None (no inputs). If all None, tt will try to read from attitude parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_pointings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pointings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_pointings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attitude</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attitude</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Attitude</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="o">=</span> <span class="n">attitude</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The attitude must be `scoords.attitude.Attitude` object&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please input the pointings of as least two axes or attitude!&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># if you have the inputs of x, y and z pointings, the attitude will be overwritten by a None value regardless of the input for the attitude variable.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;unix&quot;</span><span class="p">)</span>  <span class="c1"># this is not necessary, but just to make sure evething works fine...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_pointings</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">x_pointings</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># this is not necessary, but just to make sure evething works fine...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">z_pointings</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">z_pointings</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># this is not necessary, but just to make sure evething works fine...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_earth_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">earth_zenith</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">earth_zenith</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># this is not necessary, but just to make sure evething works fine...</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
                       
<div class="viewcode-block" id="SpacecraftFile.parse_from_file">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.parse_from_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses timestamps, axis positions from file and returns to __init__.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str</span>
<span class="sd">            The file path of the pointings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cosipy.spacecraftfile.SpacecraftFile</span>
<span class="sd">            The SpacecraftFile object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">orientation_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;EN&quot;</span><span class="p">))</span>
        <span class="n">time_stamps</span> <span class="o">=</span> <span class="n">orientation_file</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">axis_1</span> <span class="o">=</span> <span class="n">orientation_file</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">axis_2</span> <span class="o">=</span> <span class="n">orientation_file</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
        <span class="n">axis_3</span> <span class="o">=</span> <span class="n">orientation_file</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
        <span class="n">altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orientation_file</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])</span> 
        <span class="n">livetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orientation_file</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">livetime</span> <span class="o">=</span> <span class="n">livetime</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># left end points, so remove last bin. </span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time_stamps</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;unix&quot;</span><span class="p">)</span>
        <span class="n">xpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">axis_1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">axis_1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        <span class="n">zpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">axis_2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">axis_2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        <span class="n">earthpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">axis_3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">axis_3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">x_pointings</span> <span class="o">=</span> <span class="n">xpointings</span><span class="p">,</span> <span class="n">z_pointings</span> <span class="o">=</span> <span class="n">zpointings</span><span class="p">,</span> <span class="n">earth_zenith</span> <span class="o">=</span> <span class="n">earthpointings</span><span class="p">,</span> <span class="n">altitude</span> <span class="o">=</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">livetime</span><span class="o">=</span><span class="n">livetime</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_time">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the array pf pointing times as a astropy.Time object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time_array : numpy.ndarray, optional</span>
<span class="sd">            The time array (the default is `None`, which implies the time array will be taken from the instance).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.time.Time</span>
<span class="sd">            The time stamps of the orientation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">time_array</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;unix&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time_array</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;unix&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_altitude">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_altitude">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the array of Earth altitude.</span>

<span class="sd">        </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy array</span>
<span class="sd">            the Earth altitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>   

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_time_delta">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_time_delta">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_time_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of the time period between neighbouring time points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time_array : numpy.ndarray, optional</span>
<span class="sd">           The time delta array (the default is `None`, which implies the time array will be taken from the instance).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        time_delta : astropy.time.Time</span>
<span class="sd">            The time difference between the neighbouring time stamps.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">time_array</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_array</span><span class="p">)</span>

        <span class="n">time_delta</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_delta</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">time_delta</span></div>


<div class="viewcode-block" id="SpacecraftFile.interpolate_direction">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.interpolate_direction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">interpolate_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Linearly interpolates position at a given time between two timestamps.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trigger : astropy.time.Time</span>
<span class="sd">            The time of the event.</span>
<span class="sd">        idx : int</span>
<span class="sd">            The closest index in the pointing to the trigger time.</span>
<span class="sd">        direction : numpy.ndarray</span>
<span class="sd">            The pointing axis (x,z).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            The interpolated positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_direction_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">trigger</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">direction</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="n">new_direction_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">trigger</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">direction</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">360</span> <span class="o">+</span> <span class="n">direction</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
            <span class="n">new_direction_long</span> <span class="o">=</span> <span class="n">new_direction_long</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_direction_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">trigger</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_direction_long</span><span class="p">,</span> <span class="n">new_direction_lat</span><span class="p">])</span></div>


<div class="viewcode-block" id="SpacecraftFile.source_interval">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.source_interval">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">source_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SpacecraftFile file class object for the source interval.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : astropy.time.Time</span>
<span class="sd">            The start time of the orientation period.</span>
<span class="sd">        stop : astropy.time.Time</span>
<span class="sd">            The end time of the orientation period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cosipy.spacecraft.SpacecraftFile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">format</span> <span class="o">!=</span> <span class="s1">&#39;unix&#39;</span> <span class="ow">or</span> <span class="n">stop</span><span class="o">.</span><span class="n">format</span> <span class="o">!=</span> <span class="s1">&#39;unix&#39;</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">unix</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">unix</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start time cannot be after stop time.&quot;</span><span class="p">)</span>

        <span class="n">stop_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_x_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_z_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_earth_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earth_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_earth_altitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_livetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livetime</span><span class="p">[</span><span class="n">start_idx</span> <span class="p">:</span> <span class="n">stop_idx</span><span class="p">]</span> 

        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">x_direction_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_direction</span><span class="p">)</span>
            <span class="n">z_direction_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_direction</span><span class="p">)</span>
            <span class="n">earth_direction_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earth_direction</span><span class="p">)</span>

            <span class="n">new_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">new_x_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_x_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_x_direction</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_direction_start</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">new_z_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_z_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_z_direction</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z_direction_start</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
	    
            <span class="n">new_earth_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earth_direction</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_earth_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_earth_direction</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">earth_direction_start</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Use linear interpolation to get starting altitude at desired time. </span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="n">starting_alt</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_earth_altitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  
            <span class="n">new_earth_altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_earth_altitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">starting_alt</span><span class="p">)</span>

            <span class="c1"># SAA livetime:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">livetime</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">udpated_livetime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_livetime</span> <span class="o">=</span> <span class="n">new_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
            <span class="n">new_livetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livetime</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop_idx</span><span class="p">]</span>
            <span class="n">new_livetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_livetime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">updated_livetime</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">value</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">stop_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_time</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">x_direction_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_direction</span><span class="p">)</span>
            <span class="n">z_direction_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_direction</span><span class="p">)</span>
            <span class="n">earth_direction_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_direction</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earth_direction</span><span class="p">)</span>

            <span class="n">new_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">new_times</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">new_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_times</span><span class="p">,</span> <span class="n">stop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">new_x_direction</span> <span class="o">=</span> <span class="n">new_x_direction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_x_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_x_direction</span><span class="p">,</span> <span class="p">[</span><span class="n">x_direction_stop</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">new_z_direction</span> <span class="o">=</span> <span class="n">new_z_direction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_z_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_z_direction</span><span class="p">,</span> <span class="p">[</span><span class="n">z_direction_stop</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="n">new_earth_direction</span> <span class="o">=</span> <span class="n">new_earth_direction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_earth_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_earth_direction</span><span class="p">,</span> <span class="p">[</span><span class="n">earth_direction_stop</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Use linear interpolation to get starting altitude at desired time.</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="n">stop_alt</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_earth_altitude</span> <span class="o">=</span> <span class="n">new_earth_altitude</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_earth_altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_earth_altitude</span><span class="p">,</span> <span class="p">[</span><span class="n">stop_alt</span><span class="p">])</span>

            <span class="c1"># SAA livetime:</span>
            <span class="k">if</span> <span class="n">new_livetime</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">udpated_livetime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">updated_livetime</span> <span class="o">=</span> <span class="n">new_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_times</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">new_livetime</span> <span class="o">=</span> <span class="n">new_livetime</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_livetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_livetime</span><span class="p">,</span> <span class="n">updated_livetime</span><span class="p">)</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">new_times</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;unix&quot;</span><span class="p">)</span>
        <span class="n">xpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">new_x_direction</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">new_x_direction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        <span class="n">zpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">new_z_direction</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">new_z_direction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        <span class="n">earthpointings</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">new_earth_direction</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">new_earth_direction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
        <span class="n">altitude</span> <span class="o">=</span> <span class="n">new_earth_altitude</span>
    
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">x_pointings</span> <span class="o">=</span> <span class="n">xpointings</span><span class="p">,</span> <span class="n">z_pointings</span> <span class="o">=</span> <span class="n">zpointings</span><span class="p">,</span> <span class="n">earth_zenith</span> <span class="o">=</span> <span class="n">earthpointings</span><span class="p">,</span> <span class="n">altitude</span> <span class="o">=</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">livetime</span> <span class="o">=</span> <span class="n">new_livetime</span><span class="p">)</span></div>

      
<div class="viewcode-block" id="SpacecraftFile.get_attitude">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_attitude">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_attitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_pointings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the x, y and z pointings to the attitude of the telescope.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the x axis of the local coordinate system attached to the spacecraft (the default is `None`, which implies that the x pointings will be taken from the instance).</span>
<span class="sd">        y_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the y axis of the local coordinate system attached to the spacecraft (the default is `None`, which implies that the y pointings will be taken from the instance).</span>
<span class="sd">        z_pointings : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The pointings (galactic system) of the z axis of the local coordinate system attached to the spacecraft (the default is `None`, which implies that the z pointings will be taken from the instance).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scoords.attitude.Attitude</span>
<span class="sd">            The attitude of the spacecraft.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the attitude is None, we will calculate from the x, y and z pointings</span>
            <span class="k">if</span> <span class="n">x_pointings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_pointings</span> <span class="o">=</span> <span class="n">x_pointings</span>
            <span class="k">if</span> <span class="n">y_pointings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_pointings</span> <span class="o">=</span> <span class="n">y_pointings</span>
            <span class="k">if</span> <span class="n">z_pointings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z_pointings</span> <span class="o">=</span> <span class="n">z_pointings</span>

            <span class="n">list_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_pointings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pointings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_pointings</span><span class="p">]</span>
            <span class="n">coord_list_of_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># check how many pointings the user input</span>

            <span class="c1"># Check if the user input pointings from at least two axes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_list_of_path</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must input pointings of at least two axes&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the inputs are SkyCoord objects</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coord_list_of_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SkyCoord</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The coordiates must be a SkyCoord object&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="o">=</span> <span class="n">Attitude</span><span class="o">.</span><span class="n">from_axes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_pointings</span><span class="p">,</span>
                                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pointings</span><span class="p">,</span>
                                               <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_pointings</span><span class="p">,</span>
                                               <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_target_in_sc_frame">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_target_in_sc_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_target_in_sc_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">target_coord</span><span class="p">,</span> <span class="n">attitude</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the x, y and z pointings of the spacescraft axes to the path of the source in the spacecraft frame.</span>
<span class="sd">        Specify the pointings of at least two axes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_name : str</span>
<span class="sd">            The name of the target object.</span>
<span class="sd">        target_coord : astropy.coordinates.SkyCoord</span>
<span class="sd">            The coordinates of the target object.</span>
<span class="sd">        attitude: scoords.Attitude, optional</span>
<span class="sd">            The attitude of the spacecraft (the default is `None`, which implies the attitude will be taken from the instance).</span>
<span class="sd">        quiet : bool, default=False</span>
<span class="sd">            Setting `True` to stop printing the messages.</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            Setting `True` to save the target coordinates in the spacecraft frame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.coordinates.SkyCoord</span>
<span class="sd">            The target coordinates in the spacecraft frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">attitude</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="o">=</span> <span class="n">attitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attitude</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">=</span> <span class="n">target_name</span>
        <span class="k">if</span> <span class="n">quiet</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now converting to the Spacecraft frame...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_path_cartesian</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attitude</span><span class="o">.</span><span class="n">rot</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">(),</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                           <span class="n">representation_type</span> <span class="o">=</span> <span class="s1">&#39;cartesian&#39;</span><span class="p">,</span>
                                           <span class="n">frame</span> <span class="o">=</span> <span class="n">SpacecraftFrame</span><span class="p">())</span>

        <span class="c1"># The conversion above is in Cartesian frame, so we have to convert them to the spherical one.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src_path_spherical</span> <span class="o">=</span> <span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_path_cartesian</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">src_path_cartesian</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">src_path_cartesian</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quiet</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion completed!&quot;</span><span class="p">)</span>

        <span class="c1"># generate the numpy array of l and b to save to a npy file</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_path_spherical</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># note that 0 is Quanty, 1 is latitude and 2 is longitude and they are in rad not deg</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_path_spherical</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_path_lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_name</span><span class="o">+</span><span class="s2">&quot;_source_path_in_SC_frame&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_path_lb</span><span class="p">)</span>

        <span class="c1"># convert to SkyCoord objects to get the output object of this method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_path_skycoord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_path_lb</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_path_lb</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">SpacecraftFrame</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_path_skycoord</span></div>



<div class="viewcode-block" id="SpacecraftFile.get_dwell_map">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_dwell_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dwell_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">src_path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pa_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the dwell time map for the source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        response : str or pathlib.Path</span>
<span class="sd">            The path to the response file.</span>
<span class="sd">        src_path : astropy.coordinates.SkyCoord, optional</span>
<span class="sd">            The movement of source in the detector frame (the default is `None`, which implies that the `src_path` will be read from the instance).</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            Set True to save the dwell time map.</span>
<span class="sd">        pa_convention : str, optional</span>
<span class="sd">             Polarization convention of response (&#39;RelativeX&#39;, &#39;RelativeY&#39;, or &#39;RelativeZ&#39;) </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mhealpy.containers.healpix_map.HealpixMap</span>
<span class="sd">            The dwell time map.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_file</span> <span class="o">=</span> <span class="n">response</span>

        <span class="c1"># Define the dts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_delta</span><span class="p">()</span>
        
        <span class="c1"># define the target source path in the SC frame</span>
        <span class="k">if</span> <span class="n">src_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_path_skycoord</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">src_path</span>
        <span class="c1"># check if the target source path is astropy.Skycoord object</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SkyCoord</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The coordinates of the source movement in the Spacecraft frame must be a SkyCoord object&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The dimensions of the dts or source coordinates are not correct. Please check your inputs.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">FullDetectorResponse</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_file</span><span class="p">,</span> <span class="n">pa_convention</span><span class="o">=</span><span class="n">pa_convention</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span> <span class="o">=</span> <span class="n">HealpixMap</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="n">response</span><span class="p">,</span>
                                        <span class="n">coordsys</span> <span class="o">=</span> <span class="n">SpacecraftFrame</span><span class="p">())</span>

        <span class="c1"># Get the unique pixels to weight, and sum all the correspondint weights first, so</span>
        <span class="c1"># each pixels needs to be called only once.</span>
        <span class="c1"># Based on https://stackoverflow.com/questions/23268605/grouping-indices-of-unique-elements-in-numpy</span>
        
        <span class="c1"># remove the last value. Effectively a 0th order interpolations</span>
        <span class="n">pixels</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span><span class="o">.</span><span class="n">get_interp_weights</span><span class="p">(</span><span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_path_skycoord</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  

        <span class="n">weighted_duration</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span>

        <span class="n">pixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">weighted_duration</span> <span class="o">=</span> <span class="n">weighted_duration</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">pixels_argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

        <span class="n">pixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[</span><span class="n">pixels_argsort</span><span class="p">]</span>
        <span class="n">weighted_duration</span> <span class="o">=</span> <span class="n">weighted_duration</span><span class="p">[</span><span class="n">pixels_argsort</span><span class="p">]</span>

        <span class="n">first_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="kc">True</span><span class="p">],</span> <span class="n">pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">pixels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        
        <span class="n">pixel_unique</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[</span><span class="n">first_unique</span><span class="p">]</span>

        <span class="n">splits</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">first_unique</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">pixel_durations</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_duration</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span><span class="n">stop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">splits</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">pixels</span><span class="o">.</span><span class="n">size</span><span class="p">))]</span>
        
        <span class="k">for</span> <span class="n">pix</span><span class="p">,</span> <span class="n">dur</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pixel_unique</span><span class="p">,</span> <span class="n">pixel_durations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span><span class="p">[</span><span class="n">pix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dur</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">save</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">+</span> <span class="s2">&quot;_DwellMap.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_scatt_map">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_scatt_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scatt_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">target_coord</span><span class="p">,</span>
                       <span class="n">nside</span><span class="p">,</span>
                       <span class="n">scheme</span> <span class="o">=</span> <span class="s1">&#39;ring&#39;</span><span class="p">,</span>
                       <span class="n">coordsys</span> <span class="o">=</span> <span class="s1">&#39;galactic&#39;</span><span class="p">,</span>
                       <span class="n">r_earth</span> <span class="o">=</span> <span class="mf">6378.0</span><span class="p">,</span>
                       <span class="n">earth_occ</span> <span class="o">=</span> <span class="kc">True</span>
                       <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bin the spacecraft attitude history into a 4D histogram that </span>
<span class="sd">        contains the accumulated time the axes of the spacecraft where </span>
<span class="sd">        looking at a given direction. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_coord : astropy.coordinates.SkyCoord</span>
<span class="sd">            The coordinates of the target object. </span>
<span class="sd">        nside : int</span>
<span class="sd">            The nside of the scatt map.</span>
<span class="sd">        scheme : str, optional</span>
<span class="sd">            The scheme of the scatt map (the default is &quot;ring&quot;)</span>
<span class="sd">        coordsys : str, optional</span>
<span class="sd">            The coordinate system used in the scatt map (the default is &quot;galactic).</span>
<span class="sd">        r_earth : float, optional</span>
<span class="sd">            Earth radius in km (default is 6378 km).</span>
<span class="sd">        earth_occ : bool, optional</span>
<span class="sd">            Option to include Earth occultation in scatt map calculation.</span>
<span class="sd">            Default is True. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        h_ori : cosipy.spacecraftfile.scatt_map.SpacecraftAttitudeMap</span>
<span class="sd">            The spacecraft attitude map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get orientations</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="n">attitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attitude</span><span class="p">()</span>

        <span class="c1"># Altitude at each point in the orbit:</span>
        <span class="n">altitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_altitude</span>

        <span class="c1"># Earth zenith at each point in the orbit:</span>
        <span class="n">earth_zenith</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_zenith</span>

        <span class="c1"># Fill (only 2 axes needed to fully define the orientation)</span>
        <span class="n">h_ori</span> <span class="o">=</span> <span class="n">SpacecraftAttitudeMap</span><span class="p">(</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span><span class="p">,</span>
                                      <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">,</span>
                                      <span class="n">coordsys</span> <span class="o">=</span> <span class="n">coordsys</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">attitudes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_axes</span><span class="p">()</span>
       
        <span class="c1"># Get max angle based on altitude:</span>
        <span class="n">max_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">r_earth</span><span class="o">/</span><span class="p">(</span><span class="n">r_earth</span> <span class="o">+</span> <span class="n">altitude</span><span class="p">))</span>
        <span class="n">max_angle</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># angles in degree</span>
        
        <span class="c1"># Calculate angle between source direction and Earth zenith</span>
        <span class="c1"># for each time stamp:</span>
        <span class="n">src_angle</span> <span class="o">=</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">earth_zenith</span><span class="p">)</span>
        
        <span class="c1"># Get pointings that are occulted by Earth:</span>
        <span class="n">earth_occ_index</span> <span class="o">=</span> <span class="n">src_angle</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">max_angle</span>

        <span class="c1"># Define weights and set to 0 if blocked by Earth:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livetime</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

        <span class="k">if</span> <span class="n">earth_occ</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">weight</span><span class="p">[</span><span class="n">earth_occ_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>        
        
        <span class="c1"># Fill histogram:</span>
        <span class="n">h_ori</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h_ori</span></div>



<div class="viewcode-block" id="SpacecraftFile.get_psr_rsp">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_psr_rsp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_psr_rsp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dwell_map</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pa_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the point source response based on the response file and dwell time map.</span>
<span class="sd">        dts is used to find the exposure time for this observation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        :response : str or pathlib.Path, optional</span>
<span class="sd">            The response for the observation (the defaul is `None`, which implies that the `response` will be read from the instance).</span>
<span class="sd">        dwell_map : str, optional</span>
<span class="sd">            The time dwell map for the source, you can load saved dwell time map using this parameter if you&#39;ve saved it before (the defaul is `None`, which implies that the `dwell_map` will be read from the instance).</span>
<span class="sd">        dts : numpy.ndarray or str, optional</span>
<span class="sd">            The elapsed time for each pointing. It must has the same size as the pointings. If you have saved this array, you can load it using this parameter (the defaul is `None`, which implies that the `dts` will be read from the instance).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ei_edges : numpy.ndarray</span>
<span class="sd">            The edges of the incident energy.</span>
<span class="sd">        Ei_lo : numpy.ndarray</span>
<span class="sd">            The lower edges of the incident energy.</span>
<span class="sd">        Ei_hi : numpy.ndarray</span>
<span class="sd">            The upper edges of the incident energy.</span>
<span class="sd">        Em_edges : numpy.ndarray</span>
<span class="sd">            The edges of the measured energy.</span>
<span class="sd">        Em_lo : numpy.ndarray</span>
<span class="sd">            The lower edges of the measured energy.</span>
<span class="sd">        Em_hi : numpy.ndarray</span>
<span class="sd">            The upper edges of the measured energy.</span>
<span class="sd">        areas : numpy.ndarray</span>
<span class="sd">            The effective area of each energy bin.</span>
<span class="sd">        matrix : numpy.ndarray</span>
<span class="sd">            The energy dispersion matrix.</span>
<span class="sd">        pa_convention : str, optional</span>
<span class="sd">             Polarization convention of response (&#39;RelativeX&#39;, &#39;RelativeY&#39;, or &#39;RelativeZ&#39;) </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># will use the response defined in the previous steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response_file</span> <span class="o">=</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">dwell_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># must use is None, or it throws error!</span>
            <span class="k">pass</span> <span class="c1"># will use the dwelltime map calculated in the previous steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span> <span class="o">=</span> <span class="n">HealpixMap</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span><span class="n">dwell_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dts</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_delta</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dts</span> <span class="o">=</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">dts</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">FullDetectorResponse</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_file</span><span class="p">,</span> <span class="n">pa_convention</span><span class="o">=</span><span class="n">pa_convention</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>

            <span class="c1"># get point source response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psr</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_point_source_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwell_map</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Ei_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;Ei&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ei_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># use float32 to match the requirement of the data type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ei_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Em_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;Em&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

         <span class="c1"># get the effective area and matrix</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the effective area ...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psr</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="s1">&#39;Ei&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span class="n">contents</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">spectral_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psr</span><span class="o">.</span><span class="n">project</span><span class="p">([</span><span class="s1">&#39;Ei&#39;</span><span class="p">,</span><span class="s1">&#39;Em&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span class="n">contents</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_lo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span> <span class="c1"># initate the matrix</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the energy redistribution matrix ...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_lo</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">new_raw</span> <span class="o">=</span> <span class="n">spectral_response</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="n">spectral_response</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">new_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ei_edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ei_lo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ei_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em_edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span></div>



<div class="viewcode-block" id="SpacecraftFile.get_arf">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_arf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_arf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the point source response to an arf file that can be read by XSPEC.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_name: str, optional</span>
<span class="sd">            The name of the arf file to save. (the default is `None`, which implies that the saving name will be the target name of the instance).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">out_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="n">out_name</span>

        <span class="c1"># blow write the arf file</span>
        <span class="n">copyright_string</span><span class="o">=</span><span class="s2">&quot;  FITS (Flexible Image Transport System) format is defined in &#39;Astronomy and Astrophysics&#39;, volume 376, page 359; bibcode: 2001A&amp;A...376..359H &quot;</span>

        <span class="c1">## Create PrimaryHDU</span>
        <span class="n">primaryhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span> <span class="c1"># create an empty primary HDU</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span> <span class="c1"># since it&#39;s an empty HDU, I can just change the data type by resetting the BIPTIX value</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copyright_string</span> <span class="c1"># add comments</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span> <span class="c1"># print headers and their values</span>

        <span class="n">col1_energ_lo</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ENERG_LO&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">)</span>
        <span class="n">col2_energ_hi</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ENERG_HI&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span><span class="p">)</span>
        <span class="n">col3_specresp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;SPECRESP&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;cm**2&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">col1_energ_lo</span><span class="p">,</span> <span class="n">col2_energ_hi</span><span class="p">,</span> <span class="n">col3_specresp</span><span class="p">])</span> <span class="c1"># create a ColDefs (column-definitions) object for all columns</span>
        <span class="n">specresp_bintablehdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="c1"># create a binary table HDU object</span>

        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;label for field   1&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM1&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT1&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;physical unit of field&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;label for field   2&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM2&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;physical unit of field&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE3&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;label for field   3&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM3&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT3&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;physical unit of field&quot;</span>

        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SPECRESP&quot;</span><span class="p">,</span><span class="s2">&quot;name of this binary table extension&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;mission/satellite name&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;instrument/detector name&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span><span class="s2">&quot;filter in use&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RESPONSE&quot;</span><span class="p">,</span><span class="s2">&quot;dataset relates to spectral response&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SPECRESP&quot;</span><span class="p">,</span><span class="s2">&quot;extension contains an ARF&quot;</span><span class="p">)</span>
        <span class="n">specresp_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUVERS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;1.1.0&quot;</span><span class="p">,</span><span class="s2">&quot;version of format&quot;</span><span class="p">)</span>

        <span class="n">new_arfhdus</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">primaryhdu</span><span class="p">,</span> <span class="n">specresp_bintablehdu</span><span class="p">])</span>
        <span class="n">new_arfhdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.arf&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_rmf">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_rmf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the point source response to an rmf file that can be read by XSPEC.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_name: str, optional</span>
<span class="sd">            The name of the arf file to save. (the default is None, which implies that the saving name will be the target name of the instance).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">out_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="n">out_name</span>

        <span class="c1"># blow write the arf file</span>
        <span class="n">copyright_string</span><span class="o">=</span><span class="s2">&quot;  FITS (Flexible Image Transport System) format is defined in &#39;Astronomy and Astrophysics&#39;, volume 376, page 359; bibcode: 2001A&amp;A...376..359H &quot;</span>

        <span class="c1">## Create PrimaryHDU</span>
        <span class="n">primaryhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span> <span class="c1"># create an empty primary HDU</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span> <span class="c1"># since it&#39;s an empty HDU, I can just change the data type by resetting the BIPTIX value</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copyright_string</span> <span class="c1"># add comments</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span> <span class="c1"># print headers and their values</span>

        <span class="c1">## Create binary table HDU for MATRIX</span>
        <span class="c1">### prepare colums</span>
        <span class="n">energ_lo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">energ_hi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_grp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f_chan</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_chan</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_lo</span><span class="p">)):</span>
            <span class="n">energ_lo_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">energ_hi_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ei_hi</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nz_matrix_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># non-zero index for the matrix</span>
                <span class="n">subsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">nz_matrix_idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">nz_matrix_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">n_grp_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subsets</span><span class="p">))</span>
                <span class="n">f_chan_temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">n_chan_temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">matrix_temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_grp_temp</span><span class="p">):</span>
                    <span class="n">f_chan_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">subsets</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">n_chan_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">subsets</span><span class="p">[</span><span class="n">m</span><span class="p">])]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">nz_matrix_idx</span><span class="p">:</span>
                    <span class="n">matrix_temp</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="n">m</span><span class="p">]]</span>
                <span class="n">f_chan_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_chan_temp</span><span class="p">))</span>
                <span class="n">n_chan_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_chan_temp</span><span class="p">))</span>
                <span class="n">matrix_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix_temp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_grp_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">f_chan_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">n_chan_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">matrix_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>

            <span class="n">energ_lo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energ_lo_temp</span><span class="p">)</span>
            <span class="n">energ_hi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energ_hi_temp</span><span class="p">)</span>
            <span class="n">n_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_grp_temp</span><span class="p">)</span>
            <span class="n">f_chan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_chan_temp</span><span class="p">)</span>
            <span class="n">n_chan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_chan_temp</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_temp</span><span class="p">)</span>

        <span class="n">col1_energ_lo</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ENERG_LO&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">energ_lo</span><span class="p">)</span>
        <span class="n">col2_energ_hi</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ENERG_HI&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">energ_hi</span><span class="p">)</span>
        <span class="n">col3_n_grp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;N_GRP&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">n_grp</span><span class="p">)</span>
        <span class="n">col4_f_chan</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;F_CHAN&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PI(54)&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">f_chan</span><span class="p">)</span>
        <span class="n">col5_n_chan</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;N_CHAN&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PI(54)&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">n_chan</span><span class="p">)</span>
        <span class="n">col6_n_chan</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;MATRIX&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PE(161)&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">col1_energ_lo</span><span class="p">,</span> <span class="n">col2_energ_hi</span><span class="p">,</span> <span class="n">col3_n_grp</span><span class="p">,</span> <span class="n">col4_f_chan</span><span class="p">,</span> <span class="n">col5_n_chan</span><span class="p">,</span> <span class="n">col6_n_chan</span><span class="p">])</span> <span class="c1"># create a ColDefs (column-definitions) object for all columns</span>
        <span class="n">matrix_bintablehdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="c1"># create a binary table HDU object</span>

        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   1 &quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;physical unit of field&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   2&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;physical unit of field&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   3 &quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 2-byte INTEGER&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   4&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: variable length array&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   5&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: variable length array&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE6&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   6&quot;</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM6&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: variable length array&quot;</span>

        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;MATRIX&quot;</span><span class="p">,</span><span class="s2">&quot;name of this binary table extension&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;mission/satellite name&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;instrument/detector name&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span><span class="s2">&quot;filter in use&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CHANTYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PI&quot;</span><span class="p">,</span><span class="s2">&quot;total number of detector channels&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DETCHANS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">),</span><span class="s2">&quot;total number of detector channels&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OGIP&quot;</span><span class="p">,</span><span class="s2">&quot;format conforms to OGIP standard&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RESPONSE&quot;</span><span class="p">,</span><span class="s2">&quot;dataset relates to spectral response&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RSP_MATRIX&quot;</span><span class="p">,</span><span class="s2">&quot;dataset is a spectral response matrix&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUVERS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;1.3.0&quot;</span><span class="p">,</span><span class="s2">&quot;version of format&quot;</span><span class="p">)</span>
        <span class="n">matrix_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TLMIN4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;minimum value legally allowed in column 4&quot;</span><span class="p">)</span>

        <span class="c1">## Create binary table HDU for EBOUNDS</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">)))</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">)</span>
        <span class="n">e_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span><span class="p">)</span>

        <span class="n">col1_channels</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CHANNEL&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">col2_e_min</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E_MIN&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">e_min</span><span class="p">)</span>
        <span class="n">col3_e_max</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E_MAX&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;keV&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">e_max</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">col1_channels</span><span class="p">,</span> <span class="n">col2_e_min</span><span class="p">,</span> <span class="n">col3_e_max</span><span class="p">])</span>
        <span class="n">ebounds_bintablehdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   1&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 2-byte INTEGER&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   2&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;physical unit of field&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field   3&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 4-byte REAL&quot;</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;physical unit of field&quot;</span>

        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;EBOUNDS&quot;</span><span class="p">,</span><span class="s2">&quot;name of this binary table extension&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;mission/satellite&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span><span class="s2">&quot;nstrument/detector name&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span><span class="s2">&quot;filter in use&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CHANTYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PI&quot;</span><span class="p">,</span><span class="s2">&quot;channel type (PHA or PI)&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DETCHANS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">),</span><span class="s2">&quot;total number of detector channels&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OGIP&quot;</span><span class="p">,</span><span class="s2">&quot;format conforms to OGIP standard&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RESPONSE&quot;</span><span class="p">,</span><span class="s2">&quot;dataset relates to spectral response&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;EBOUNDS&quot;</span><span class="p">,</span><span class="s2">&quot;dataset is a spectral response matrix&quot;</span><span class="p">)</span>
        <span class="n">ebounds_bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUVERS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">,</span><span class="s2">&quot;version of format&quot;</span><span class="p">)</span>

        <span class="n">new_rmfhdus</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">primaryhdu</span><span class="p">,</span> <span class="n">matrix_bintablehdu</span><span class="p">,</span><span class="n">ebounds_bintablehdu</span><span class="p">])</span>
        <span class="n">new_rmfhdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.rmf&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="SpacecraftFile.get_pha">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.get_pha">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_counts</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">rmf_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">arf_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bkg_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exposure_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s2">&quot;COSI&quot;</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s2">&quot;COSI&quot;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the pha file that can be read by XSPEC. This file stores the counts info of the source.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        src_counts : numpy.ndarray</span>
<span class="sd">            The counts in each energy band. If you have src_counts with unit counts/kev/s, you must convert it to counts by multiplying it with exposure time and the energy band width.</span>
<span class="sd">        errors : numpy.ndarray</span>
<span class="sd">            The error for counts. It has the same unit requirement as src_counts.</span>
<span class="sd">        rmf_file : str, optional</span>
<span class="sd">            The rmf file name to be written into the pha file (the default is `None`, which implies that it uses the rmf file generate by function `get_rmf`)</span>
<span class="sd">        arf_file : str, optional</span>
<span class="sd">            The arf file name to be written into the pha file (the default is `None`, which implies that it uses the arf file generate by function `get_arf`)</span>
<span class="sd">        bkg_file : str, optional</span>
<span class="sd">            The background file name (the default is `None`, which implied the `src_counts` is source counts only).</span>
<span class="sd">        exposure_time : float, optional</span>
<span class="sd">            The exposure time for this source observation (the default is `None`, which implied that the exposure time will be calculated by `dts`).</span>
<span class="sd">        dts : numpy.ndarray, optional</span>
<span class="sd">            It&#39;s used to calculate the exposure time. It has the same effect as `exposure_time`. If both `exposure_time` and `dts` are given, `dts` will write over the exposure_time (the default is `None`, which implies that the `dts` will be read from the instance).</span>
<span class="sd">        telescope : str, optional</span>
<span class="sd">            The name of the telecope (the default is &quot;COSI&quot;).</span>
<span class="sd">        instrument : str, optional</span>
<span class="sd">            The instrument name (the default is &quot;COSI&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src_counts</span> <span class="o">=</span> <span class="n">src_counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span>

        <span class="k">if</span> <span class="n">bkg_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg_file</span> <span class="o">=</span> <span class="n">bkg_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg_file</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg_file</span> <span class="o">=</span> <span class="n">bkg_file</span>

        <span class="k">if</span> <span class="n">rmf_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rmf_file</span> <span class="o">=</span> <span class="n">rmf_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rmf_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.rmf&#39;</span>

        <span class="k">if</span> <span class="n">arf_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arf_file</span> <span class="o">=</span> <span class="n">arf_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arf_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.arf&#39;</span>

        <span class="k">if</span> <span class="n">exposure_time</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="n">exposure_time</span>
        <span class="k">if</span> <span class="n">dts</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str_or_array</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_counts</span><span class="p">)</span>

        <span class="c1"># define other hardcoded inputs</span>
        <span class="n">copyright_string</span><span class="o">=</span><span class="s2">&quot;  FITS (Flexible Image Transport System) format is defined in &#39;Astronomy and Astrophysics&#39;, volume 376, page 359; bibcode: 2001A&amp;A...376..359H &quot;</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_number</span><span class="p">)</span>

        <span class="c1"># Create PrimaryHDU</span>
        <span class="n">primaryhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span> <span class="c1"># create an empty primary HDU</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span> <span class="c1"># since it&#39;s an empty HDU, I can just change the data type by resetting the BIPTIX value</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copyright_string</span> <span class="c1"># add comments</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">telescope</span> <span class="c1"># add telescope keyword valie</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span> <span class="c1"># add instrument keyword valie</span>
        <span class="n">primaryhdu</span><span class="o">.</span><span class="n">header</span> <span class="c1"># print headers and their values</span>

        <span class="c1"># Create binary table HDU</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span> <span class="c1"># I guess I need to convert the dtype to match the format J</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_counts</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>  <span class="c1"># int32 is not enough for counts</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span> <span class="c1"># int32 is not enough for errors</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CHANNEL&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">col2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;COUNTS&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
        <span class="n">col3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;STAT_ERR&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">a3</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span><span class="p">])</span> <span class="c1"># create a ColDefs (column-definitions) object for all columns</span>
        <span class="n">bintablehdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="c1"># create a binary table HDU object</span>

        <span class="c1">#add other BinTableHDU hear keywords,their values, and comments</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field 1&quot;</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 32-bit integer&quot;</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label for field 2&quot;</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TFORM2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data format of field: 32-bit integer&quot;</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s2">&quot;TUNIT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;physical unit of field 2&quot;</span>


        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SPECTRUM&quot;</span><span class="p">,</span><span class="s2">&quot;name of this binary table extension&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span><span class="s2">&quot;telescope/mission name&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="s2">&quot;instrument/detector name&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span><span class="s2">&quot;filter type if any&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXPOSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">,</span><span class="s2">&quot;integration time in seconds&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BACKFILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg_file</span><span class="p">,</span><span class="s2">&quot;background filename&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BACKSCAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;background scaling factor&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CORRFILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span><span class="s2">&quot;associated correction filename&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CORRSCAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;correction file scaling factor&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CORRSCAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;correction file scaling factor&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;RESPFILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmf_file</span><span class="p">,</span><span class="s2">&quot;associated rmf filename&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ANCRFILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arf_file</span><span class="p">,</span><span class="s2">&quot;associated arf filename&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;AREASCAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;area scaling factor&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;STAT_ERR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;statistical error specified if any&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SYS_ERR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;systematic error specified if any&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;GROUPING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;grouping of the data has been defined if any&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;QUALITY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;data quality information specified&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OGIP&quot;</span><span class="p">,</span><span class="s2">&quot;format conforms to OGIP standard&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUCLAS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SPECTRUM&quot;</span><span class="p">,</span><span class="s2">&quot;PHA dataset&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HDUVERS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;1.2.1&quot;</span><span class="p">,</span><span class="s2">&quot;version of format&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;POISSERR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Poissonian errors to be assumed, T as True&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CHANTYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PI&quot;</span><span class="p">,</span><span class="s2">&quot;channel type (PHA or PI)&quot;</span><span class="p">)</span>
        <span class="n">bintablehdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DETCHANS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_number</span><span class="p">,</span><span class="s2">&quot;total number of detector channels&quot;</span><span class="p">)</span>

        <span class="n">new_phahdus</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">primaryhdu</span><span class="p">,</span> <span class="n">bintablehdu</span><span class="p">])</span>
        <span class="n">new_phahdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.pha&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span></div>



<div class="viewcode-block" id="SpacecraftFile.plot_arf">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.plot_arf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_arf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the arf fits file, plot and save it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            The directory if the arf fits file (the default is `None`, which implies the file name will be read from the instance).</span>
<span class="sd">        save_name: str, optional</span>
<span class="sd">            The name of the saved image of effective area (the default is `None`, which implies the file name will be read from the instance).</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The dpi of the saved image (the default is 300).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.arf&#39;</span>

        <span class="k">if</span> <span class="n">save_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span> <span class="o">=</span> <span class="n">save_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arf</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># read file</span>

        <span class="c1"># SPECRESP HDU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specresp_hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arf</span><span class="p">[</span><span class="s2">&quot;SPECRESP&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specresp_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SPECRESP&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specresp_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ENERG_LO&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specresp_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ENERG_HI&quot;</span><span class="p">])</span>

        <span class="n">E_center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">E_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_lo</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Em_hi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">E_center</span><span class="p">,</span><span class="n">E_edges</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">areas</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Effective area&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy[$keV$]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Effective area [$cm^2$]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective_area_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="c1">#fig.show()</span>

        <span class="k">return</span></div>



<div class="viewcode-block" id="SpacecraftFile.plot_rmf">
<a class="viewcode-back" href="../../../api/spacecraftfile.html#cosipy.spacecraftfile.SpacecraftFile.plot_rmf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_rmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the rmf fits file, plot and save it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            The directory if the arf fits file (the default is `None`, which implies the file name will be read from the instance).</span>
<span class="sd">        save_name: str, optional</span>
<span class="sd">            The name of the saved image of effective area (the default is `None`, which implies the file name will be read from the instance).</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The dpi of the saved image (the default is 300).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.rmf&#39;</span>

        <span class="k">if</span> <span class="n">save_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span> <span class="o">=</span> <span class="n">save_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span>

        <span class="c1"># Read rmf file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmf</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># read file</span>

        <span class="c1"># Read the ENOUNDS information</span>
        <span class="n">ebounds_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmf</span><span class="p">[</span><span class="s2">&quot;EBOUNDS&quot;</span><span class="p">]</span>
        <span class="n">channel_low</span> <span class="o">=</span> <span class="n">ebounds_ext</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;E_MIN&quot;</span><span class="p">]</span> <span class="c1"># energy bin lower edges for channels (channels are just incident energy bins)</span>
        <span class="n">channel_high</span> <span class="o">=</span> <span class="n">ebounds_ext</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;E_MAX&quot;</span><span class="p">]</span> <span class="c1"># energy bin higher edges for channels (channels are just incident energy bins)</span>

        <span class="c1"># Read the MATRIX extension</span>
        <span class="n">matrix_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmf</span><span class="p">[</span><span class="s1">&#39;MATRIX&#39;</span><span class="p">]</span>
        <span class="c1">#logger.info(repr(matrix_hdu.header[:60]))</span>
        <span class="n">energy_low</span> <span class="o">=</span> <span class="n">matrix_ext</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ENERG_LO&quot;</span><span class="p">]</span> <span class="c1"># energy bin lower edges for measured energies</span>
        <span class="n">energy_high</span> <span class="o">=</span> <span class="n">matrix_ext</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ENERG_HI&quot;</span><span class="p">]</span> <span class="c1"># energy bin higher edges for measured energies</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">matrix_ext</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Create a 2-d numpy array and store probability data into the redistribution matrix</span>
        <span class="n">rmf_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_low</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_low</span><span class="p">)))</span> <span class="c1"># create an empty matrix</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># i is the measured energy index, examine the matrix_ext.data rows by rows</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># if the sum of probabilities is zero, then skip since there is no data at all</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#measured_energy_index = np.argwhere(energy_low == data[157][0])[0][0]</span>
                <span class="n">f_chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># get the starting channel of each subsets</span>
                <span class="n">n_chann</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># get the number of channels in each subsets</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="c1"># get the probabilities of this row (incident energy)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f_chan</span><span class="p">:</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span> <span class="o">+</span> <span class="n">n_chann</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">f_chan</span> <span class="o">==</span> <span class="n">k</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># generate the cha</span>
                    <span class="n">indices</span> <span class="o">+=</span> <span class="n">channels</span> <span class="c1"># fappend the channels togeter</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="n">rmf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">m</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># write the probabilities into the empty matrix</span>


        <span class="c1"># plot the redistribution matrix</span>
        <span class="n">xcenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">energy_low</span><span class="o">+</span><span class="n">energy_high</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_center_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">xcenter</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">y_center_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xcenter</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">energy_all_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy_low</span><span class="p">,</span><span class="n">energy_high</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#bin_edges = np.array([incident_energy_bins,incident_energy_bins]) # doesn&#39;t work</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">energy_all_edges</span><span class="p">,</span> <span class="n">energy_all_edges</span><span class="p">))</span>
        <span class="c1">#logger.info(bin_edges)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmf_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="c1">#logger.info(type(probability))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_center_coords</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y_center_coords</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Incident energy [$keV$]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Measured energy [$keV$]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Redistribution matrix&quot;</span><span class="p">)</span>
        <span class="c1">#plt.xlim([70,10000])</span>
        <span class="c1">#plt.ylim([70,10000])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redistribution_matrix_for_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">save_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="c1">#plt.show()</span>

        <span class="k">return</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, COSI Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>