

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Source Injector &mdash; cosipy __version__ = &#34;0.3.4&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f9fafa83"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Continuum Background Estimation" href="../background_estimation/continuum_estimation/BG_estimation_example.html" />
    <link rel="prev" title="Image Deconvolution example for 511 keV with spacecraft attitude binning" href="../image_deconvolution/511keV/ScAttBinning/511keV-ScAtt-ImageDeconvolution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            cosipy
              <img src="../../_static/cosipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../DataIO/DataIO_example.html">Data format and handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../response/SpacecraftFile.html">Spacecraft file: attitude and position</a></li>
<li class="toctree-l2"><a class="reference internal" href="../response/DetectorResponse.html">Detector response and signal expectation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ts_map/Parallel_TS_map_computation.html">TS Map: localizing a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spectral_fits/continuum_fit/grb/SpectralFit_GRB.html">Fitting the spectrum of a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spectral_fits/continuum_fit/crab/SpectralFit_Crab.html">Fitting the spectrum of the Crab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html">Extended source model fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../image_deconvolution/511keV/ScAttBinning/511keV-ScAtt-ImageDeconvolution.html">Image deconvolution</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Source injector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Get-the-data">Get the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Inject-a-source-response">Inject a source response</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Method-1-:-Define-the-point-source">Method 1 : Define the point source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Read-orientation-file">Read orientation file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Get-the-expected-counts-and-save-to-a-data-file">Get the expected counts and save to a data file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Compare-with-Simulation">Compare with Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Method-2:-Read-the-spectrum-from-a-file">Method 2: Read the spectrum from a file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#SpecFromDat-Class-Explanation">SpecFromDat Class Explanation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Read orientation file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Get the expected counts and save to a data file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Compare with Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(Optional)-Compare-simulated-data-with-existing-models">(Optional) Compare simulated data with existing models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../background_estimation/continuum_estimation/BG_estimation_example.html">Continuum Background Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../background_estimation/line_background/line_background_estimation_example_notebook.html">Line background estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarization/ASAD_method.html">Polarization (ASAD method)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../other_examples.html">Other examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/index.html">For developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cosipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Source Injector</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/source_injector/Point_source_injector.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Source-Injector">
<h1>Source Injector<a class="headerlink" href="#Source-Injector" title="Link to this heading">ÔÉÅ</a></h1>
<p>The source injector can produce mock simulated data independent of the MEGAlib software.</p>
<p>Standard data simulation requires the users to install and use MEGAlib to convolve the source model with the detector effects to generate data. The source injector utilizes the response generated by intensive simulation, which contains the statistical detector effects. With the source injector, you can convolve response, source model, and orientation to gain the mock data quickly.</p>
<p>The advantages of using the source injector include:</p>
<ul class="simple">
<li><p>No need to install and use MEGAlib</p></li>
<li><p>Get the data much faster than the standard simulation pipeline</p></li>
<li><p>The generated data are in the format that can be used for spectral fitting, localization, imaging, etc.</p></li>
</ul>
<p>The disadvantages are:</p>
<ul class="simple">
<li><p>The data are binned based on the binning of the response, which means that you lost the unbinned event distribution as you will get from the MEGAlib pipeline.</p></li>
<li><p>If the response is coarse, the data you generated might not be precise.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d
import astropy.units as u
from pathlib import Path
from astropy.coordinates import SkyCoord
from astromodels.functions.function import Function1D, FunctionMeta
from cosipy import SpacecraftFile, SourceInjector
from histpy import Histogram
from threeML import Powerlaw, Band, Model, PointSource
from cosipy.threeml.custom_functions import SpecFromDat
from cosipy.util import fetch_wasabi_file
import shutil
import os
import h5py as h5

%matplotlib inline
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_dir = Path(&quot;&quot;)  # Current directory by default. Modify if you want a different path
</pre></div>
</div>
</div>
<section id="Get-the-data">
<h2>Get the data<a class="headerlink" href="#Get-the-data" title="Link to this heading">ÔÉÅ</a></h2>
<p>The data can be downloaded by running the cells below. Each respective cell also gives the wasabi file path and file size.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
zipped_response_path = data_dir/&quot;SMEXv12.Continuum.HEALPixO3_10bins_log_flat.binnedimaging.imagingresponse.nonsparse_nside8.area.good_chunks_unzip.earthocc.zip&quot;
response_path = data_dir/&quot;SMEXv12.Continuum.HEALPixO3_10bins_log_flat.binnedimaging.imagingresponse.nonsparse_nside8.area.good_chunks_unzip.earthocc.h5&quot;

# download response file ~839.62 MB
if not response_path.exists():

    fetch_wasabi_file(&quot;COSI-SMEX/DC2/Responses/SMEXv12.Continuum.HEALPixO3_10bins_log_flat.binnedimaging.imagingresponse.nonsparse_nside8.area.good_chunks_unzip.earthocc.zip&quot;, zipped_response_path)

    # unzip the response file
    shutil.unpack_archive(zipped_response_path)

    # delete the zipped response to save space
    os.remove(zipped_response_path)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
orientation_path = data_dir/&quot;20280301_3_month_with_orbital_info.ori&quot;

# download orientation file ~684.38 MB
if not orientation_path.exists():
    fetch_wasabi_file(&quot;COSI-SMEX/DC2/Data/Orientation/20280301_3_month_with_orbital_info.ori&quot;, orientation_path)
</pre></div>
</div>
</div>
</section>
<section id="Inject-a-source-response">
<h2>Inject a source response<a class="headerlink" href="#Inject-a-source-response" title="Link to this heading">ÔÉÅ</a></h2>
<section id="Method-1-:-Define-the-point-source">
<h3>Method 1 : Define the point source<a class="headerlink" href="#Method-1-:-Define-the-point-source" title="Link to this heading">ÔÉÅ</a></h3>
<p>In this method, we are setting up an analytical function (eg: a power law model) to simulate the spectral characteristics of a point source:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Defind the Crab spectrum

alpha_inj = -1.99
beta_inj = -2.32
E0_inj = 531. * (alpha_inj - beta_inj) * u.keV
xp_inj = E0_inj * (alpha_inj + 2) / (alpha_inj - beta_inj)
piv_inj = 100. * u.keV
K_inj = 7.56e-4 / u.cm / u.cm / u.s / u.keV

spectrum_inj = Band()

spectrum_inj.alpha.min_value = -2.14
spectrum_inj.alpha.max_value = 3.0
spectrum_inj.beta.min_value = -5.0
spectrum_inj.beta.max_value = -2.15
spectrum_inj.xp.min_value = 1.0

spectrum_inj.alpha.value = alpha_inj
spectrum_inj.beta.value = beta_inj
spectrum_inj.xp.value = xp_inj.value
spectrum_inj.K.value = K_inj.value
spectrum_inj.piv.value = piv_inj.value

spectrum_inj.xp.unit = xp_inj.unit
spectrum_inj.K.unit = K_inj.unit
spectrum_inj.piv.unit = piv_inj.unit
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">01:12:02 </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The current value of the parameter beta (</span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">-2.0</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">) was above the new maximum </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">-2.15</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">. </span><a href="file:///Users/shengyong/conda_envs/source_injector/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/shengyong/conda_envs/source_injector/lib/python3.10/site-packages/astromodels/core/parameter.py#794" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">794</span></a>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define the coordinate of the point source
source_coord = SkyCoord(l = 184.5551, b = -05.7877, frame = &quot;galactic&quot;, unit = &quot;deg&quot;)

# define the Crab point source
point_source = PointSource(&#39;Crab&#39;, l = source_coord.l.deg, b = source_coord.b.deg, spectral_shape=spectrum_inj)

# define the model. The model can contain multiple point sources.
model = Model(point_source)
</pre></div>
</div>
</div>
</section>
<section id="Read-orientation-file">
<h3>Read orientation file<a class="headerlink" href="#Read-orientation-file" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read the 3-month orientation
# It is the pointing of the spacecraft during the the mock simlulation
ori = SpacecraftFile.parse_from_file(orientation_path)
</pre></div>
</div>
</div>
</section>
<section id="Get-the-expected-counts-and-save-to-a-data-file">
<h3>Get the expected counts and save to a data file<a class="headerlink" href="#Get-the-expected-counts-and-save-to-a-data-file" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define an injector by the response
injector = SourceInjector(response_path = response_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

file_path = &quot;Crab_model_injected.h5&quot;

# Check if the file exists and remove it if it does
if os.path.exists(file_path):
    os.remove(file_path)

# Get the data of the injected source
model_injected = injector.inject_model(model = model, orientation = ori, make_spectrum_plot = True, data_save_path = file_path)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 21.4 s, sys: 3.73 s, total: 25.1 s
Wall time: 26.4 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_16_1.png" src="../../_images/tutorials_source_injector_Point_source_injector_16_1.png" />
</div>
</div>
</section>
<section id="Compare-with-Simulation">
<h3>Compare with Simulation<a class="headerlink" href="#Compare-with-Simulation" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
# download simulated data
simulated_data_path = data_dir/&quot;crab_3months_unbinned_data.hdf5&quot;

# download orientation file ~89.50 MB
if not simulated_data_path.exists():
    fetch_wasabi_file(&quot;COSI-SMEX/cosipy_tutorials/source_injector/crab_3months_unbinned_data.hdf5&quot;, simulated_data_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>simulated = Histogram.open(simulated_data_path)
injected = Histogram.open(&quot;Crab_model_injected.h5&quot;)

ax,plot = simulated.project(&quot;Em&quot;).draw(label = &quot;Simulated Crab&quot;, color = &quot;orange&quot;)
injected.project(&quot;Em&quot;).draw(ax, label = &quot;Injected Crab&quot;, color = &quot;purple&quot;, linestyle = &quot;dotted&quot;)

ax.legend()
ax.set_xscale(&quot;log&quot;)
ax.set_yscale(&quot;log&quot;)
ax.set_ylabel(&quot;Counts&quot;)
ax.set_title(&quot;Simulated and injected Crab&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Simulated and injected Crab&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_19_1.png" src="../../_images/tutorials_source_injector_Point_source_injector_19_1.png" />
</div>
</div>
</section>
<section id="Method-2:-Read-the-spectrum-from-a-file">
<h3>Method 2: Read the spectrum from a file<a class="headerlink" href="#Method-2:-Read-the-spectrum-from-a-file" title="Link to this heading">ÔÉÅ</a></h3>
<p>In this method, we‚Äôre loading spectral data from a file (crab_spec.dat) and visualizing it:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load data from the text file, skipping the index column
dataFlux = np.genfromtxt(&quot;crab_spec.dat&quot;,comments = &quot;#&quot;,usecols = (2),skip_footer=1,skip_header=5)
dataEn = np.genfromtxt(&quot;crab_spec.dat&quot;,comments = &quot;#&quot;,usecols = (1),skip_footer=1,skip_header=5)
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Plot the data
plt.figure(figsize=(10, 6))
plt.plot(dataEn, dataFlux, marker=&quot;o&quot;, linestyle=&quot;-&quot;)
plt.xscale(&quot;log&quot;)
plt.yscale(&quot;log&quot;)
plt.xlabel(&quot;energies (keV)&quot;)
# plt.ylabel(&quot;Flux (keV cm^-2 s^-1)&quot;)
plt.ylabel(&quot;Flux_ph (ph/cm^2/s/keV)&quot;)
plt.title(&quot;Energy Flux Data&quot;)
plt.grid(True)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_23_0.png" src="../../_images/tutorials_source_injector_Point_source_injector_23_0.png" />
</div>
</div>
<p>We use a custom class <code class="docutils literal notranslate"><span class="pre">SpecFromDat</span></code> to define a spectrum from data loaded from a CSV file <code class="docutils literal notranslate"><span class="pre">crab_spec.dat</span></code></p>
</section>
<section id="SpecFromDat-Class-Explanation">
<h3>SpecFromDat Class Explanation<a class="headerlink" href="#SpecFromDat-Class-Explanation" title="Link to this heading">ÔÉÅ</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">SpecFromDat</span></code> class represents a spectrum loaded from a data file (<code class="docutils literal notranslate"><span class="pre">dat</span></code>, <code class="docutils literal notranslate"><span class="pre">txt</span></code>, <code class="docutils literal notranslate"><span class="pre">csv</span></code> etc.,). It provides methods to handle spectral data and evaluate the spectrum at specified energy values (<code class="docutils literal notranslate"><span class="pre">x</span></code>).</p>
<section id="Class-Description">
<h4>Class Description<a class="headerlink" href="#Class-Description" title="Link to this heading">ÔÉÅ</a></h4>
<ul class="simple">
<li><p><strong>Description</strong>:</p>
<ul>
<li><p>A spectrum loaded from a data file (<code class="docutils literal notranslate"><span class="pre">dat</span></code>).</p></li>
</ul>
</li>
</ul>
</section>
<section id="Parameters">
<h4>Parameters<a class="headerlink" href="#Parameters" title="Link to this heading">ÔÉÅ</a></h4>
<ul class="simple">
<li><p><strong>K</strong>:</p>
<ul>
<li><p><strong>Description</strong>: Normalization factor.</p></li>
<li><p><strong>Initial Value</strong>: 1.0</p></li>
<li><p><strong>Is Normalization</strong>: True</p></li>
<li><p><strong>Transformation</strong>: log10</p></li>
<li><p><strong>Min</strong>: 1e-30</p></li>
<li><p><strong>Max</strong>: 1e3</p></li>
<li><p><strong>Delta</strong>: 0.1</p></li>
<li><p><strong>Units</strong>: <code class="docutils literal notranslate"><span class="pre">ph/cm2/s</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="Properties">
<h4>Properties<a class="headerlink" href="#Properties" title="Link to this heading">ÔÉÅ</a></h4>
<ul class="simple">
<li><p><strong>dat</strong>:</p>
<ul>
<li><p><strong>Description</strong>: The data file from which the spectrum is loaded.</p></li>
<li><p><strong>Initial Value</strong>: <code class="docutils literal notranslate"><span class="pre">test.dat</span></code></p></li>
<li><p><strong>Defer</strong>: True</p></li>
<li><p><strong>Units</strong>:</p>
<ul>
<li><p><strong>Energy</strong>: <code class="docutils literal notranslate"><span class="pre">keV</span></code>.</p></li>
<li><p><strong>Flux</strong>: <code class="docutils literal notranslate"><span class="pre">ph/cm2/s/keV</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="Functionality">
<h4>Functionality<a class="headerlink" href="#Functionality" title="Link to this heading">ÔÉÅ</a></h4>
<ul class="simple">
<li><p>Loads flux (<code class="docutils literal notranslate"><span class="pre">dataFlux</span></code>) and energy (<code class="docutils literal notranslate"><span class="pre">dataEn</span></code>) from the specified data file (<code class="docutils literal notranslate"><span class="pre">self.dat.value</span></code>).</p></li>
<li><p>Normalizes <code class="docutils literal notranslate"><span class="pre">dataFlux</span></code> using the widths of energy bins.</p></li>
<li><p>Interpolates (<code class="docutils literal notranslate"><span class="pre">interp1d</span></code>) the normalized data to create a function (<code class="docutils literal notranslate"><span class="pre">fun</span></code>) for evaluating the spectrum.</p></li>
<li><p>Evaluates the spectrum (<code class="docutils literal notranslate"><span class="pre">fun(x)</span></code>) at given energy values (<code class="docutils literal notranslate"><span class="pre">x</span></code>), scaled by the normalization factor (<code class="docutils literal notranslate"><span class="pre">K</span></code>).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>spectrum = SpecFromDat(K=1/18, dat=&quot;crab_spec.dat&quot;)

# Define the coordinate of the point source
source_coord = SkyCoord(l = 184.5551, b = -05.7877, frame = &quot;galactic&quot;, unit = &quot;deg&quot;)

# define the Crab point source
point_source = PointSource(&#39;Crab&#39;, l = source_coord.l.deg, b = source_coord.b.deg, spectral_shape = spectrum)

# define the model. One model can contain multiple point sources.
model = Model(point_source)
</pre></div>
</div>
</div>
</section>
</section>
<section id="id1">
<h3>Read orientation file<a class="headerlink" href="#id1" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read the 3-month orientation
# It is the pointing of the spacecraft during the the mock simlulation
ori = SpacecraftFile.parse_from_file(orientation_path)
</pre></div>
</div>
</div>
</section>
<section id="id2">
<h3>Get the expected counts and save to a data file<a class="headerlink" href="#id2" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define an injector by the response
injector = SourceInjector(response_path = response_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

file_path = &quot;crab_piecewise_injected.h5&quot;

# Check if the file exists and remove it if it does
if os.path.exists(file_path):
    os.remove(file_path)

# Get the data of the injected source
model_injected = injector.inject_model(model = model, orientation = ori, make_spectrum_plot = True, data_save_path = file_path)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 23.5 s, sys: 4.82 s, total: 28.3 s
Wall time: 31.1 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_31_1.png" src="../../_images/tutorials_source_injector_Point_source_injector_31_1.png" />
</div>
</div>
</section>
<section id="id3">
<h3>Compare with Simulation<a class="headerlink" href="#id3" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
# download simulated data
simulated_data_path = data_dir/&quot;crab_3months_unbinned_data.hdf5&quot;

# download orientation file ~89.50 MB
if not simulated_data_path.exists():
    fetch_wasabi_file(&quot;COSI-SMEX/cosipy_tutorials/source_injector/crab_3months_unbinned_data.hdf5&quot;, simulated_data_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>simulated = Histogram.open(simulated_data_path)
injected = Histogram.open(&quot;crab_piecewise_injected.h5&quot;)

ax,plot = simulated.project(&quot;Em&quot;).draw(label = &quot;Simulated Crab&quot;, color = &quot;orange&quot;)
injected.project(&quot;Em&quot;).draw(ax, label = &quot;Injected Crab&quot;, color = &quot;purple&quot;, linestyle = &quot;dotted&quot;)

ax.legend()
ax.set_xscale(&quot;log&quot;)
ax.set_yscale(&quot;log&quot;)
ax.set_ylabel(&quot;Counts&quot;)
ax.set_title(&quot;Simulated and injected Crab&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Simulated and injected Crab&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_34_1.png" src="../../_images/tutorials_source_injector_Point_source_injector_34_1.png" />
</div>
</div>
</section>
<section id="(Optional)-Compare-simulated-data-with-existing-models">
<h3>(Optional) Compare simulated data with existing models<a class="headerlink" href="#(Optional)-Compare-simulated-data-with-existing-models" title="Link to this heading">ÔÉÅ</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_injected = Histogram.open(&quot;Crab_model_injected.h5&quot;).project(&quot;Em&quot;)
piecewise_injected = Histogram.open(&quot;crab_piecewise_injected.h5&quot;).project(&quot;Em&quot;)

ax, plot = model_injected.draw(label=&quot;injected with model&quot;, color=&quot;green&quot;)

piecewise_injected.draw(
    ax, label=&quot;injected with piesewise function&quot;, color=&quot;orange&quot;, linestyle=&quot;dashed&quot;
)


ax.set_xscale(&quot;log&quot;)
ax.set_yscale(&quot;log&quot;)
ax.legend()
ax.set_ylabel(&quot;Counts&quot;)
ax.set_title(&quot;Comparison b/w model and piecewise injected counts&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Comparison b/w model and piecewise injected counts&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_source_injector_Point_source_injector_36_1.png" src="../../_images/tutorials_source_injector_Point_source_injector_36_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../image_deconvolution/511keV/ScAttBinning/511keV-ScAtt-ImageDeconvolution.html" class="btn btn-neutral float-left" title="Image Deconvolution example for 511 keV with spacecraft attitude binning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../background_estimation/continuum_estimation/BG_estimation_example.html" class="btn btn-neutral float-right" title="Continuum Background Estimation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, COSI Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>