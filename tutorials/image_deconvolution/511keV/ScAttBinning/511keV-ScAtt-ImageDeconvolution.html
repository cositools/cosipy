

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Deconvolution example for 511 keV with spacecraft attitude binning &mdash; cosipy __version__ = &#34;0.3.4&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=f9fafa83"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Source Injector" href="../../../source_injector/Point_source_injector.html" />
    <link rel="prev" title="Diffuse 511 Spectral Fit in Galactic Coordinates" href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            cosipy
              <img src="../../../../_static/cosipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../DataIO/DataIO_example.html">Data format and handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../response/SpacecraftFile.html">Spacecraft file: attitude and position</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../response/DetectorResponse.html">Detector response and signal expectation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ts_map/Parallel_TS_map_computation.html">TS Map: localizing a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/continuum_fit/grb/SpectralFit_GRB.html">Fitting the spectrum of a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/continuum_fit/crab/SpectralFit_Crab.html">Fitting the spectrum of the Crab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html">Extended source model fitting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Image deconvolution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#0.-Files-needed-for-this-notebook">0. Files needed for this notebook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.-Read-the-response-matrix">1. Read the response matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Read-binned-511keV-binned-files-(source-and-background)">2. Read binned 511keV binned files (source and background)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Load-the-coordsys-conversion-matrix">3. Load the coordsys conversion matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4.-Imaging-deconvolution">4. Imaging deconvolution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Brief-overview-of-the-image-deconvolution">Brief overview of the image deconvolution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4-1.-Prepare-DataInterface-containing-all-necessary-datasets">4-1. Prepare DataInterface containing all necessary datasets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#4-2.-Initialize-the-instance-of-the-image-deconvolution-class">4-2. Initialize the instance of the image deconvolution class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Initialize-image_deconvolution">Initialize image_deconvolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(You-can-change-the-parameters-as-follows)">(You can change the parameters as follows)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4-3.-Start-the-image-deconvolution">4-3. Start the image deconvolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#5.-Analyze-the-results">5. Analyze the results</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Log-likelihood">Log-likelihood</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Alpha-(the-factor-used-for-the-acceleration)">Alpha (the factor used for the acceleration)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Background-normalization">Background normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-reconstructed-images">The reconstructed images</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../source_injector/Point_source_injector.html">Source injector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../background_estimation/continuum_estimation/BG_estimation_example.html">Continuum Background Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../background_estimation/line_background/line_background_estimation_example_notebook.html">Line background estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../polarization/ASAD_method.html">Polarization (ASAD method)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../other_examples.html">Other examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/index.html">For developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cosipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Image Deconvolution example for 511 keV with spacecraft attitude binning</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/tutorials/image_deconvolution/511keV/ScAttBinning/511keV-ScAtt-ImageDeconvolution.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Image-Deconvolution-example-for-511-keV-with-spacecraft-attitude-binning">
<h1>Image Deconvolution example for 511 keV with spacecraft attitude binning<a class="headerlink" href="#Image-Deconvolution-example-for-511-keV-with-spacecraft-attitude-binning" title="Link to this heading"></a></h1>
<p>updated on 2025-03-19</p>
<p>This notebook focuses on the image deconvolution with the spacecraft attitude (scatt) binning method. Using an older 511keV thin disk 3-month simulation data created for DC2, an example of the image analysis will be presented. If you have not run through 511keV-ScAtt-DataReduction.ipynb, please do that first as this analysis requires data that is binned slightly differently than the standard Galactic binning method shown in the DataIO tutorial.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import logging
import sys
logger = logging.getLogger(&#39;cosipy&#39;)
logger.setLevel(logging.INFO)
logger.addHandler(logging.StreamHandler(sys.stdout))
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from histpy import Histogram, HealpixAxis, Axis, Axes
from mhealpy import HealpixMap
from astropy.coordinates import SkyCoord, cartesian_to_spherical, Galactic

from cosipy.response import FullDetectorResponse
from cosipy.spacecraftfile import SpacecraftFile
from cosipy.ts_map.TSMap import TSMap
from cosipy.data_io import UnBinnedData, BinnedData
from cosipy.image_deconvolution import SpacecraftAttitudeExposureTable, CoordsysConversionMatrix, DataIF_COSI_DC2, ImageDeconvolution

# cosipy uses astropy units
import astropy.units as u
from astropy.units import Quantity
from astropy.coordinates import SkyCoord
from astropy.time import Time
from astropy.table import Table
from astropy.io import fits
from scoords import Attitude, SpacecraftFrame

#3ML is needed for spectral modeling
from threeML import *
from astromodels import Band

#Other standard libraries
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.gridspec import GridSpec

import healpy as hp
from tqdm.autonotebook import tqdm

%matplotlib inline
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">22:06:23 </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The naima package is not available. Models that depend on it will not be         </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">functions.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py#48" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">48</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">available                                                                         </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The GSL library or the pygsl wrapper cannot be loaded. Models that depend on it  </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">functions.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py#69" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">69</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">will not be available.                                                            </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/numba-0.58.0-py3.10-macosx-14-arm64.egg/numba/core/decorators.py:262: NumbaDeprecationWarning: <span class="ansi-bold">numba.generated_jit is deprecated. Please see the documentation at: https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-generated-jit for more information and advice on a suitable replacement.</span>
  warnings.warn(msg, NumbaDeprecationWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The ebltable package is not available. Models that depend on it will not be     </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/absorption.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">absorption.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/astromodels/functions/functions_1D/absorption.py#33" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">33</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">available                                                                        </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/numba-0.58.0-py3.10-macosx-14-arm64.egg/numba/core/decorators.py:262: NumbaDeprecationWarning: <span class="ansi-bold">numba.generated_jit is deprecated. Please see the documentation at: https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-generated-jit for more information and advice on a suitable replacement.</span>
  warnings.warn(msg, NumbaDeprecationWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #00ffaf; text-decoration-color: #00ffaf">INFO    </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Starting 3ML!                                                                     </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#39" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">39</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> WARNINGs here are </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">NOT</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> errors                                                      </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#40" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">40</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> but are inform you about optional packages that can be installed                  </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#41" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">41</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold"> to disable these messages, turn off start_warning in your config file</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">            </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#44" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">44</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">22:06:23 </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> ROOT minimizer not available                                                </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">minimization.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py#1345" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1345</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Multinest minimizer not available                                           </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">minimization.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py#1357" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1357</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> PyGMO is not available                                                      </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">minimization.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/minimizer/minimization.py#1369" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1369</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The cthreeML package is not installed. You will not be able to use plugins which  </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#94" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">94</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">require the C/C++ interface (currently HAWC)                                       </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Could not import plugin HAWCLike.py. Do you have the relative instrument         </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#144" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">144</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">software installed and configured?                                                </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Could not import plugin FermiLATLike.py. Do you have the relative instrument     </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#144" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">144</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">software installed and configured?                                                </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> No fermitools installed                                              </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/utils/data_builders/fermi/lat_transient_builder.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">lat_transient_builder.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/utils/data_builders/fermi/lat_transient_builder.py#44" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">44</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable OMP_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal         </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable MKL_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal         </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable NUMEXPR_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal     </span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/ckierans/Software/COSItools/COSItools/python-env/lib/python3.10/site-packages/threeML-2.4.3.dev1-py3.10.egg/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<section id="0.-Files-needed-for-this-notebook">
<h2>0. Files needed for this notebook<a class="headerlink" href="#0.-Files-needed-for-this-notebook" title="Link to this heading"></a></h2>
<p>You should have used the 511keV-ScAtt-DataReduction.ipynb notebook to download and bin the data sets needed for this notebook. Specicially, you now should have:</p>
<ul class="simple">
<li><p>511keV_scatt_binning_DC2_bkg.hdf5</p></li>
<li><p>511keV_scatt_binning_DC2_event.hdf5</p></li>
<li><p>ccm.hdf5</p></li>
</ul>
<p>From docs/tutorials/image_deconvolution/511keV/ScAttBinning, you will also need:</p>
<ul class="simple">
<li><p>inputs_511keV.yaml</p></li>
<li><p>imagedeconvolution_parfile_scatt_511keV.yml</p></li>
</ul>
</section>
<section id="1.-Read-the-response-matrix">
<h2>1. Read the response matrix<a class="headerlink" href="#1.-Read-the-response-matrix" title="Link to this heading"></a></h2>
<p>please modify “path_data” corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>path_data = &quot;/path/to/data/&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>response_path = path_data + &quot;SMEXv12.511keV.HEALPixO4.binnedimaging.imagingresponse.nonsparse_nside16.area.h5&quot;

response = FullDetectorResponse.open(response_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>response
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FILENAME: &#39;/Users/ckierans/Software/COSItools/COSItools/cosipy/docs/tutorials/image_deconvolution/511keV/ScAttBinning/SMEXv12.511keV.HEALPixO4.binnedimaging.imagingresponse.nonsparse_nside16.area.h5&#39;
AXES:
  NuLambda:
    DESCRIPTION: &#39;Location of the simulated source in the spacecraft coordinates&#39;
    TYPE: &#39;healpix&#39;
    NPIX: 3072
    NSIDE: 16
    SCHEME: &#39;RING&#39;
  Ei:
    DESCRIPTION: &#39;Initial simulated energy&#39;
    TYPE: &#39;log&#39;
    UNIT: &#39;keV&#39;
    NBINS: 1
    EDGES: [509.0 keV, 513.0 keV]
  Em:
    DESCRIPTION: &#39;Measured energy&#39;
    TYPE: &#39;log&#39;
    UNIT: &#39;keV&#39;
    NBINS: 1
    EDGES: [509.0 keV, 513.0 keV]
  Phi:
    DESCRIPTION: &#39;Compton angle&#39;
    TYPE: &#39;linear&#39;
    UNIT: &#39;deg&#39;
    NBINS: 60
    EDGES: [0.0 deg, 3.0 deg, 6.0 deg, 9.0 deg, 12.0 deg, 15.0 deg, 18.0 deg, 21.0 deg, 24.0 deg, 27.0 deg, 30.0 deg, 33.0 deg, 36.0 deg, 39.0 deg, 42.0 deg, 45.0 deg, 48.0 deg, 51.0 deg, 54.0 deg, 57.0 deg, 60.0 deg, 63.0 deg, 66.0 deg, 69.0 deg, 72.0 deg, 75.0 deg, 78.0 deg, 81.0 deg, 84.0 deg, 87.0 deg, 90.0 deg, 93.0 deg, 96.0 deg, 99.0 deg, 102.0 deg, 105.0 deg, 108.0 deg, 111.0 deg, 114.0 deg, 117.0 deg, 120.0 deg, 123.0 deg, 126.0 deg, 129.0 deg, 132.0 deg, 135.0 deg, 138.0 deg, 141.0 deg, 144.0 deg, 147.0 deg, 150.0 deg, 153.0 deg, 156.0 deg, 159.0 deg, 162.0 deg, 165.0 deg, 168.0 deg, 171.0 deg, 174.0 deg, 177.0 deg, 180.0 deg]
  PsiChi:
    DESCRIPTION: &#39;Location in the Compton Data Space&#39;
    TYPE: &#39;healpix&#39;
    NPIX: 3072
    NSIDE: 16
    SCHEME: &#39;RING&#39;

</pre></div></div>
</div>
</section>
<section id="2.-Read-binned-511keV-binned-files-(source-and-background)">
<h2>2. Read binned 511keV binned files (source and background)<a class="headerlink" href="#2.-Read-binned-511keV-binned-files-(source-and-background)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

#  background
data_bkg = BinnedData(&quot;inputs_511keV.yaml&quot;)
data_bkg.load_binned_data_from_hdf5(&quot;511keV_dc2_scatt_bkg.hdf5&quot;)

##  signal + background
data_511keV = BinnedData(&quot;inputs_511keV.yaml&quot;)
data_511keV.load_binned_data_from_hdf5(&quot;511keV_dc2_scatt_event.hdf5&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 117 ms, sys: 671 ms, total: 788 ms
Wall time: 809 ms
</pre></div></div>
</div>
</section>
<section id="3.-Load-the-coordsys-conversion-matrix">
<h2>3. Load the coordsys conversion matrix<a class="headerlink" href="#3.-Load-the-coordsys-conversion-matrix" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

ccm = CoordsysConversionMatrix.open(&quot;ccm_dc2.hdf5&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.21 s, sys: 64 ms, total: 1.28 s
Wall time: 1.28 s
</pre></div></div>
</div>
</section>
<section id="4.-Imaging-deconvolution">
<h2>4. Imaging deconvolution<a class="headerlink" href="#4.-Imaging-deconvolution" title="Link to this heading"></a></h2>
<section id="Brief-overview-of-the-image-deconvolution">
<h3>Brief overview of the image deconvolution<a class="headerlink" href="#Brief-overview-of-the-image-deconvolution" title="Link to this heading"></a></h3>
<p>Basically, we have to maximize the following likelihood function</p>
<div class="math notranslate nohighlight">
\[\log L = \sum_i X_i \log \epsilon_i - \sum_i \epsilon_i\]</div>
<p><span class="math notranslate nohighlight">\(X_i\)</span>: detected counts at <span class="math notranslate nohighlight">\(i\)</span>-th bin ( <span class="math notranslate nohighlight">\(i\)</span> : index of the Compton Data Space)</p>
<p><span class="math notranslate nohighlight">\(\epsilon_i = \sum_j R_{ij} \lambda_j + b_i\)</span> : expected counts ( <span class="math notranslate nohighlight">\(j\)</span> : index of the model space)</p>
<p><span class="math notranslate nohighlight">\(\lambda_j\)</span> : the model map (basically gamma-ray flux at <span class="math notranslate nohighlight">\(j\)</span>-th pixel)</p>
<p><span class="math notranslate nohighlight">\(b_i\)</span> : the background at <span class="math notranslate nohighlight">\(i\)</span>-th bin</p>
<p><span class="math notranslate nohighlight">\(R_{ij}\)</span> : the response matrix</p>
<p>Since we have to optimize the flux in each pixel, and the number of parameters is large, we adopt an iterative approach to find a solution of the above equation. The simplest one is the ML-EM (Maximum Likelihood Expectation Maximization) algorithm. It is also known as the Richardson-Lucy algorithm.</p>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\delta \lambda_{j}^{k} = \frac{\lambda_{j}^{k}}{\sum_{i} R_{ij}} \sum_{i} \left(\frac{ X_{i} }{\epsilon_{i}} - 1 \right) R_{ij}\]</div>
<p>We refer to <span class="math notranslate nohighlight">\(\delta \lambda_{j}^{k}\)</span> as the delta map.</p>
<p>As for now, the two improved algorithms are implemented in COSIpy.</p>
<ul class="simple">
<li><p>Accelerated ML-EM algorithm (Knoedlseder+99)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\alpha^{k} &lt; \mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k})\]</div>
<p>Practically, in order not to accelerate the algorithm excessively, we set the maximum value of <span class="math notranslate nohighlight">\(\alpha\)</span> (<span class="math notranslate nohighlight">\(\alpha_{\mathrm{max}}\)</span>). Then, <span class="math notranslate nohighlight">\(\alpha\)</span> is calculated as:</p>
<div class="math notranslate nohighlight">
\[\alpha^{k} = \mathrm{min}(\mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k}), \alpha_{\mathrm{max}})\]</div>
<ul class="simple">
<li><p>Noise damping using gaussian smoothing (Knoedlseder+05, Siegert+20)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \left[ w_j \delta \lambda_{j}^{k} \right]_{\mathrm{gauss}}\]</div>
<div class="math notranslate nohighlight">
\[w_j = \left(\sum_{i} R_{ij}\right)^\beta\]</div>
<p><span class="math notranslate nohighlight">\(\left[ ... \right]_{\mathrm{gauss}}\)</span> means that the differential image is smoothed by a gaussian filter.</p>
</section>
</section>
<section id="4-1.-Prepare-DataInterface-containing-all-necessary-datasets">
<h2>4-1. Prepare DataInterface containing all necessary datasets<a class="headerlink" href="#4-1.-Prepare-DataInterface-containing-all-necessary-datasets" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

data_interface = DataIF_COSI_DC2.load(name = &quot;511keV&quot;,
                                      event_binned_data = data_511keV.binned_data,
                                      dict_bkg_binned_data = {&quot;albedo&quot;: data_bkg.binned_data},
                                      rsp = response,
                                      coordsys_conv_matrix=ccm,
                                      is_miniDC2_format=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading the response matrix onto your computer memory...
Finished
... checking the axis ScAtt of the event and background files...
    --&gt; pass (edges)
... checking the axis Em of the event and background files...
    --&gt; pass (edges)
... checking the axis Phi of the event and background files...
    --&gt; pass (edges)
... checking the axis PsiChi of the event and background files...
    --&gt; pass (edges)
...checking the axis Em of the event and response files...
    --&gt; pass (edges)
...checking the axis Phi of the event and response files...
    --&gt; pass (edges)
...checking the axis PsiChi of the event and response files...
    --&gt; pass (edges)
The axes in the event and background files are redefined. Now they are consistent with those of the response file.
Calculating an exposure map...
Finished...
CPU times: user 6.67 s, sys: 1.49 s, total: 8.16 s
Wall time: 8.18 s
</pre></div></div>
</div>
<section id="4-2.-Initialize-the-instance-of-the-image-deconvolution-class">
<h3>4-2. Initialize the instance of the image deconvolution class<a class="headerlink" href="#4-2.-Initialize-the-instance-of-the-image-deconvolution-class" title="Link to this heading"></a></h3>
<p>First, we prepare an instance of the ImageDeconvolution class and then register the dataset and parameters for the deconvolution. After that, you can start the calculation.</p>
<p>please modify this parameter_filepath corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parameter_filepath = &quot;imagedeconvolution_parfile_scatt_511keV.yml&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution = ImageDeconvolution()

# set data_interface to image_deconvolution
image_deconvolution.set_dataset([data_interface])

# set a parameter file for the image deconvolution
image_deconvolution.read_parameterfile(parameter_filepath)
</pre></div>
</div>
</div>
</section>
<section id="Initialize-image_deconvolution">
<h3>Initialize image_deconvolution<a class="headerlink" href="#Initialize-image_deconvolution" title="Link to this heading"></a></h3>
<p>In this process, a model map is defined following the input parameters, and it is initialized. Also, it prepares ancillary data for the image deconvolution, e.g., the expected counts with the initial model map, gaussian smoothing filter etc.</p>
<p>I describe parameters in the parameter file.</p>
<section id="model_property">
<h4>model_property<a class="headerlink" href="#model_property" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>coordinate</p></td>
<td><p>str</p></td>
<td><p>the coordinate system of the model map</p></td>
<td><p>As for now, it must be ‘galactic’</p></td>
</tr>
<tr class="row-odd"><td><p>nside</p></td>
<td><p>int</p></td>
<td><p>NSIDE of the model map</p></td>
<td><p>it must be the same as NSIDE of ‘lb’ axis of the coordinate conversion matrix</p></td>
</tr>
<tr class="row-even"><td><p>scheme</p></td>
<td><p>str</p></td>
<td><p>SCHEME of the model map</p></td>
<td><p>As for now, it must be ‘ring’</p></td>
</tr>
<tr class="row-odd"><td><p>energy_edges</p></td>
<td><p>list of float [keV]</p></td>
<td><p>The definition of the energy bins of the model map</p></td>
<td><p>As for now, it must be the same as that of the response matrix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="model_initialization">
<h4>model_initialization<a class="headerlink" href="#model_initialization" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the method name to initialize the model map</p></td>
<td><p>As for now, only ‘flat’ can be used</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_flat:values</p></td>
<td><p>list of float [cm-2 s-1 sr-1]</p></td>
<td><p>the list of photon fluxes for each energy band</p></td>
<td><p>the length of the list should be the same as the length of “energy_edges” - 1</p></td>
</tr>
</tbody>
</table>
</section>
<section id="deconvolution">
<h4>deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the name of the image deconvolution algorithm</p></td>
<td><p>As for now, only ‘RL’ is supported</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:iteration</p></td>
<td><p>int</p></td>
<td><p>The maximum number of the iteration</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:acceleration</p></td>
<td><p>bool</p></td>
<td><p>whether the accelerated ML-EM algorithm (Knoedlseder+99) is used</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:alpha_max</p></td>
<td><p>float</p></td>
<td><p>the maximum value for the acceleration parameter</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:save_results_each_iteration</p></td>
<td><p>bool</p></td>
<td><p>whether an updated model map, detal map, likelihood etc. are saved at the end of each iteration</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:response_weighting</p></td>
<td><p>bool</p></td>
<td><p>whether a delta map is renormalized based on the exposure time on each pixel, namely
<span class="math notranslate nohighlight">\(w_j = (\sum_{i} R_{ij})^{\beta}\)</span> (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:response_weighting_index</p></td>
<td><p>float</p></td>
<td><p><span class="math notranslate nohighlight">\(\beta\)</span> in the above equation</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:smoothing</p></td>
<td><p>bool</p></td>
<td><p>whether a Gaussian filter is used (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:smoothing_FWHM</p></td>
<td><p>float, degree</p></td>
<td><p>the FWHM of the Gaussian in the filter</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:background_normalization_fitting</p></td>
<td><p>bool</p></td>
<td><p>whether the background normalization factor is optimized at each iteration</p></td>
<td><p>As for now, the single background normalization factor is used in all of the bins</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:background_normalization_range</p></td>
<td><p>list of float</p></td>
<td><p>the range of the normalization factor</p></td>
<td><p>should be positive</p></td>
</tr>
</tbody>
</table>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization Starts ####
&lt;&lt; Instantiating the model class AllSkyImage &gt;&gt;
---- parameters ----
coordinate: galactic
energy_edges:
  unit: keV
  value:
  - 509.0
  - 513.0
nside: 16
scheme: ring
unit: cm-2 s-1 sr-1

&lt;&lt; Setting initial values of the created model object &gt;&gt;
---- parameters ----
algorithm: flat
parameter:
  unit: cm-2 s-1 sr-1
  value:
  - 1e-4

&lt;&lt; Registering the deconvolution algorithm &gt;&gt;
Gaussian filter with FWHM of 2.0 deg will be applied to delta images ...
---- parameters ----
algorithm: RL
parameter:
  acceleration: true
  alpha_max: 10.0
  background_normalization_optimization: true
  background_normalization_range:
    albedo:
    - 0.01
    - 10.0
  iteration_max: 10
  response_weighting: true
  response_weighting_index: 0.5
  save_results: false
  save_results_directory: ./results
  smoothing: true
  smoothing_FWHM:
    unit: deg
    value: 2.0

#### Initialization Finished ####
</pre></div></div>
</div>
</section>
</section>
<section id="(You-can-change-the-parameters-as-follows)">
<h3>(You can change the parameters as follows)<a class="headerlink" href="#(You-can-change-the-parameters-as-follows)" title="Link to this heading"></a></h3>
<p>Note that when you modify the parameters, do not forget to run “initialize” again!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.override_parameter(&quot;deconvolution:parameter:iteration_max = 30&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter:background_normalization_optimization = True&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter:alpha_max = 10&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter:smoothing_FWHM:value = 3.0&quot;)

image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization Starts ####
&lt;&lt; Instantiating the model class AllSkyImage &gt;&gt;
---- parameters ----
coordinate: galactic
energy_edges:
  unit: keV
  value:
  - 509.0
  - 513.0
nside: 16
scheme: ring
unit: cm-2 s-1 sr-1

&lt;&lt; Setting initial values of the created model object &gt;&gt;
---- parameters ----
algorithm: flat
parameter:
  unit: cm-2 s-1 sr-1
  value:
  - 1e-4

&lt;&lt; Registering the deconvolution algorithm &gt;&gt;
Gaussian filter with FWHM of 3.0 deg will be applied to delta images ...
---- parameters ----
algorithm: RL
parameter:
  acceleration: true
  alpha_max: 10
  background_normalization_optimization: true
  background_normalization_range:
    albedo:
    - 0.01
    - 10.0
  iteration_max: 30
  response_weighting: true
  response_weighting_index: 0.5
  save_results: false
  save_results_directory: ./results
  smoothing: true
  smoothing_FWHM:
    unit: deg
    value: 3.0

#### Initialization Finished ####
</pre></div></div>
</div>
</section>
</section>
<section id="4-3.-Start-the-image-deconvolution">
<h2>4-3. Start the image deconvolution<a class="headerlink" href="#4-3.-Start-the-image-deconvolution" title="Link to this heading"></a></h2>
<p><strong>On a MacBook Pro with M2 Max and 96 GB memory, it takes about 2.5 min for 30 iterations.</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

image_deconvolution.run_deconvolution()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Image Deconvolution Starts ####
&lt;&lt; Initialization &gt;&gt;
The response weighting filter was calculated.
The expected count histograms were calculated with the initial model map.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1f422577bfd94596957ee4fe6cbd7a83", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
## Iteration 1/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 2.4783944324338596
  background_normalization: {&#39;albedo&#39;: 1.0003541905620614}
  loglikelihood: [-1197056.4545480786]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 2/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.575421707005236
  background_normalization: {&#39;albedo&#39;: 0.9922607778263346}
  loglikelihood: [-1148892.2494289856]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 3/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 10
  background_normalization: {&#39;albedo&#39;: 0.9989836398988254}
  loglikelihood: [-1366763.493999292]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 4/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9807935141594855}
  loglikelihood: [-1130201.6042120028]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 5/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9951524418084393}
  loglikelihood: [-1124841.8752257773]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 6/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.996710972292622}
  loglikelihood: [-1123882.6965031484]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 7/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9968855622562821}
  loglikelihood: [-1123152.1905212747]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 8/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969083706965138}
  loglikelihood: [-1122553.294395423]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 9/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969134554559144}
  loglikelihood: [-1122056.1156774329]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 10/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969163516897256}
  loglikelihood: [-1121639.152483511]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 11/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969189620579678}
  loglikelihood: [-1121286.2048804823]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 12/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969215191961452}
  loglikelihood: [-1120984.8976566715]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 13/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.996924030389004}
  loglikelihood: [-1120725.6564115596]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 14/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969264790341887}
  loglikelihood: [-1120500.9815390154]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 15/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969288556146668}
  loglikelihood: [-1120304.963459809]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 16/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969311484060269}
  loglikelihood: [-1120132.8961275548]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 17/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969333516388736}
  loglikelihood: [-1119980.969809744]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 18/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969354690483336}
  loglikelihood: [-1119846.1195404662]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 19/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969374982210912}
  loglikelihood: [-1119725.820978066]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 20/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969394510025879}
  loglikelihood: [-1119618.0199778753]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 21/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969413216933766}
  loglikelihood: [-1119520.9964885826]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 22/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Post-processing &gt;&gt;
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969431196567854}
  loglikelihood: [-1119433.3289185578]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 23/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969448441589266}
  loglikelihood: [-1119353.8044356154]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 24/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969465063444388}
  loglikelihood: [-1119281.4278713942]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 25/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969481006699753}
  loglikelihood: [-1119215.3384681274]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 26/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969496370088307}
  loglikelihood: [-1119154.8018173785]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 27/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969511182269674}
  loglikelihood: [-1119099.190130895]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 28/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969525475454646}
  loglikelihood: [-1119047.9797920918]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 29/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969539225343819}
  loglikelihood: [-1119000.7175890533]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Continue
## Iteration 30/30 ##
&lt;&lt; Pre-processing &gt;&gt;
&lt;&lt; E-step &gt;&gt;
&lt;&lt; M-step &gt;&gt;
&lt;&lt; Post-processing &gt;&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;&lt; Registering Result &gt;&gt;
  alpha: 1.0
  background_normalization: {&#39;albedo&#39;: 0.9969552449401047}
  loglikelihood: [-1118956.9770636673]
&lt;&lt; Checking Stopping Criteria &gt;&gt;
--&gt; Stop
&lt;&lt; Finalization &gt;&gt;
#### Image Deconvolution Finished ####
CPU times: user 18min 4s, sys: 3min 54s, total: 21min 58s
Wall time: 2min 41s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.results
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;iteration&#39;: 1,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c72e0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c6860&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c6b00&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 1.0003541905620614},
  &#39;alpha&#39;: &lt;Quantity 2.47839443&gt;,
  &#39;loglikelihood&#39;: [-1197056.4545480786]},
 {&#39;iteration&#39;: 2,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c4730&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c4a00&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c4760&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9922607778263346},
  &#39;alpha&#39;: &lt;Quantity 1.57542171&gt;,
  &#39;loglikelihood&#39;: [-1148892.2494289856]},
 {&#39;iteration&#39;: 3,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a42e0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a76d0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4077e1cc0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9989836398988254},
  &#39;alpha&#39;: 10,
  &#39;loglikelihood&#39;: [-1366763.493999292]},
 {&#39;iteration&#39;: 4,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a4c10&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a4ca0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a5690&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9807935141594855},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1130201.6042120028]},
 {&#39;iteration&#39;: 5,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407833c70&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407833160&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c6c20&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9951524418084393},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1124841.8752257773]},
 {&#39;iteration&#39;: 6,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407821390&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407823fa0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407821cc0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.996710972292622},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1123882.6965031484]},
 {&#39;iteration&#39;: 7,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a6a70&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078a5270&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4077e0760&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9968855622562821},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1123152.1905212747]},
 {&#39;iteration&#39;: 8,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078117e0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407813a30&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40786b940&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969083706965138},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1122553.294395423]},
 {&#39;iteration&#39;: 9,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078129b0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078136a0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407812560&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969134554559144},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1122056.1156774329]},
 {&#39;iteration&#39;: 10,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40786bdf0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407810670&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078120e0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969163516897256},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1121639.152483511]},
 {&#39;iteration&#39;: 11,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778bdc0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778ba90&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778bf10&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969189620579678},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1121286.2048804823]},
 {&#39;iteration&#39;: 12,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a2f0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407788d30&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40768fdc0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969215191961452},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1120984.8976566715]},
 {&#39;iteration&#39;: 13,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764c4f0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764ca30&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a3e0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.996924030389004},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1120725.6564115596]},
 {&#39;iteration&#39;: 14,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a560&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a800&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778b1c0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969264790341887},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1120500.9815390154]},
 {&#39;iteration&#39;: 15,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407811f00&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407812b90&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407812b00&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969288556146668},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1120304.963459809]},
 {&#39;iteration&#39;: 16,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a890&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778b5e0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778b700&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969311484060269},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1120132.8961275548]},
 {&#39;iteration&#39;: 17,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764d3f0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764d5a0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764d360&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969333516388736},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119980.969809744]},
 {&#39;iteration&#39;: 18,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407788a30&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078c5a80&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40786bac0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969354690483336},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119846.1195404662]},
 {&#39;iteration&#39;: 19,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764e950&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764f4c0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764dc60&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969374982210912},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119725.820978066]},
 {&#39;iteration&#39;: 20,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407823070&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407788f40&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778a860&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969394510025879},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119618.0199778753]},
 {&#39;iteration&#39;: 21,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4076352d0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407634f10&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4076362f0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969413216933766},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119520.9964885826]},
 {&#39;iteration&#39;: 22,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407789750&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40778abf0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4077887c0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969431196567854},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119433.3289185578]},
 {&#39;iteration&#39;: 23,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764c700&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764c2b0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764f850&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969448441589266},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119353.8044356154]},
 {&#39;iteration&#39;: 24,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764c040&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078230d0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40764e800&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969465063444388},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119281.4278713942]},
 {&#39;iteration&#39;: 25,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4078690c0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40786a5f0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40786b760&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969481006699753},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119215.3384681274]},
 {&#39;iteration&#39;: 26,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407637820&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4076363b0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4076379d0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969496370088307},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119154.8018173785]},
 {&#39;iteration&#39;: 27,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407634be0&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407635780&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407636680&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969511182269674},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119099.190130895]},
 {&#39;iteration&#39;: 28,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407634e80&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407636ef0&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x4076377f0&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969525475454646},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119047.9797920918]},
 {&#39;iteration&#39;: 29,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40768e200&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40768d600&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x40768e050&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969539225343819},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1119000.7175890533]},
 {&#39;iteration&#39;: 30,
  &#39;model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407637910&gt;,
  &#39;delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407636620&gt;,
  &#39;processed_delta_model&#39;: &lt;cosipy.image_deconvolution.allskyimage.AllSkyImageModel at 0x407634310&gt;,
  &#39;background_normalization&#39;: {&#39;albedo&#39;: 0.9969552449401047},
  &#39;alpha&#39;: 1.0,
  &#39;loglikelihood&#39;: [-1118956.9770636673]}]
</pre></div></div>
</div>
</section>
<section id="5.-Analyze-the-results">
<h2>5. Analyze the results<a class="headerlink" href="#5.-Analyze-the-results" title="Link to this heading"></a></h2>
<p>Examples to see/analyze the results are shown below.</p>
<section id="Log-likelihood">
<h3>Log-likelihood<a class="headerlink" href="#Log-likelihood" title="Link to this heading"></a></h3>
<p>Plotting the log-likelihood vs the number of iterations</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in image_deconvolution.results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;loglikelihood&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;loglikelihood&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_30_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_30_0.png" />
</div>
</div>
</section>
<section id="Alpha-(the-factor-used-for-the-acceleration)">
<h3>Alpha (the factor used for the acceleration)<a class="headerlink" href="#Alpha-(the-factor-used-for-the-acceleration)" title="Link to this heading"></a></h3>
<p>Plotting <span class="math notranslate nohighlight">\(\alpha\)</span> vs the number of iterations. <span class="math notranslate nohighlight">\(\alpha\)</span> is a parameter to accelerate the EM algorithm (see the beginning of Section 4). If it is too large, reconstructed images may have artifacts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in image_deconvolution.results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;alpha&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;alpha&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_32_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_32_0.png" />
</div>
</div>
</section>
<section id="Background-normalization">
<h3>Background normalization<a class="headerlink" href="#Background-normalization" title="Link to this heading"></a></h3>
<p>Plotting the background nomalization factor vs the number of iterations. If the background model is accurate and the image is reconstructed perfectly, this factor should be close to 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in image_deconvolution.results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;background_normalization&#39;][&#39;albedo&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;background_normalization&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_34_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_34_0.png" />
</div>
</div>
</section>
<section id="The-reconstructed-images">
<h3>The reconstructed images<a class="headerlink" href="#The-reconstructed-images" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_reconstructed_image(result, source_position = None): # source_position should be (l,b) in degrees
    iteration = result[&#39;iteration&#39;]
    image = result[&#39;model&#39;]

    for energy_index in range(image.axes[&#39;Ei&#39;].nbins):
        map_healpxmap = HealpixMap(data = image[:,energy_index], unit = image.unit)

        _, ax = map_healpxmap.plot(&#39;mollview&#39;)

        _.colorbar.set_label(str(image.unit))

        if source_position is not None:
            ax.scatter(source_position[0]*u.deg, source_position[1]*u.deg, transform=ax.get_transform(&#39;world&#39;), color = &#39;red&#39;)

        plt.title(label = f&quot;iteration = {iteration}, energy_index = {energy_index} ({image.axes[&#39;Ei&#39;].bounds[energy_index][0]}-{image.axes[&#39;Ei&#39;].bounds[energy_index][1]})&quot;)
</pre></div>
</div>
</div>
<p>Plotting the reconstructed images in all of the energy bands at the 20th iteration</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration = 29

plot_reconstructed_image(image_deconvolution.results[iteration])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_38_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_38_0.png" />
</div>
</div>
<p>An example to plot the image in the log scale</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration_idx = 29

result = image_deconvolution.results[iteration_idx]

iteration = result[&#39;iteration&#39;]
image = result[&#39;model&#39;]

data = image[:,0]
data[data &lt;= 0 * data.unit] = 1e-12 * data.unit

hp.mollview(data, min = 2e-5, norm =&#39;log&#39;, unit = str(data.unit), title = f&#39;511 keV image at {iteration}th iteration&#39;, cmap = &#39;magma&#39;)

plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_40_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-ScAtt-ImageDeconvolution_40_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html" class="btn btn-neutral float-left" title="Diffuse 511 Spectral Fit in Galactic Coordinates" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../source_injector/Point_source_injector.html" class="btn btn-neutral float-right" title="Source Injector" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, COSI Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>